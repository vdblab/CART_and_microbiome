<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Fig 3 | CART microbiome analysis</title>
  <meta name="description" content="." />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Fig 3 | CART microbiome analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Fig 3 | CART microbiome analysis" />
  
  <meta name="twitter:description" content="." />
  

<meta name="author" content="Anqi Dai" />


<meta name="date" content="2021-09-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="methods.html"/>
<script src="libs/header-attrs-2.7/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="fig-3.html"><a href="fig-3.html"><i class="fa fa-check"></i><b>3</b> Fig 3</a>
<ul>
<li class="chapter" data-level="3.1" data-path="fig-3.html"><a href="fig-3.html#b-stacked-bar-chart."><i class="fa fa-check"></i><b>3.1</b> 3B: stacked bar chart.</a></li>
<li class="chapter" data-level="3.2" data-path="fig-3.html"><a href="fig-3.html#c-alpha-and-beta-diversity-between-cart-patients-and-healthy-volunteers"><i class="fa fa-check"></i><b>3.2</b> 3C: alpha and beta diversity between CART patients and healthy volunteers</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="fig-3.html"><a href="fig-3.html#alpha-diversity-simpsons-reciprocal"><i class="fa fa-check"></i><b>3.2.1</b> alpha diversity (Simpsonâ€™s reciprocal)</a></li>
<li class="chapter" data-level="3.2.2" data-path="fig-3.html"><a href="fig-3.html#beta-diversity-pcoa-of-bray-curtis"><i class="fa fa-check"></i><b>3.2.2</b> beta diversity (PCOA of Bray-Curtis)</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="fig-3.html"><a href="fig-3.html#fig-3-ef-lefse-analysis-with-taxa-abundance-at-asv-level"><i class="fa fa-check"></i><b>3.3</b> Fig 3 E&amp;F Lefse analysis with taxa abundance at ASV level</a></li>
<li class="chapter" data-level="3.4" data-path="fig-3.html"><a href="fig-3.html#fig-3d-bayesian-modeling-with-microbiome-alpha-diversity-as-predictor"><i class="fa fa-check"></i><b>3.4</b> Fig 3D Bayesian modeling with microbiome alpha diversity as predictor</a></li>
<li class="chapter" data-level="3.5" data-path="fig-3.html"><a href="fig-3.html#fig-3g-bayesian-modeling-with-5-genera-abundance-as-predictoroutcome-cr"><i class="fa fa-check"></i><b>3.5</b> Fig 3G Bayesian modeling with 5 genera abundance as predictor(outcome CR)</a></li>
<li class="chapter" data-level="3.6" data-path="fig-3.html"><a href="fig-3.html#fig3h-histogram-to-illustrate-the-predicted-probability-of-day100-cr"><i class="fa fa-check"></i><b>3.6</b> Fig3H Histogram to illustrate the predicted probability of day100 CR</a></li>
<li class="chapter" data-level="3.7" data-path="fig-3.html"><a href="fig-3.html#fig-3i-bayesian-modeling-with-5-genera-abundance-as-predictoroutcome-toxicity"><i class="fa fa-check"></i><b>3.7</b> Fig 3I Bayesian modeling with 5 genera abundance as predictor(outcome toxicity)</a></li>
<li class="chapter" data-level="3.8" data-path="fig-3.html"><a href="fig-3.html#fig3j-histogram-to-illustrate-the-predicted-probability-of-toxicity"><i class="fa fa-check"></i><b>3.8</b> Fig3J Histogram to illustrate the predicted probability of toxicity</a></li>
<li class="chapter" data-level="3.9" data-path="fig-3.html"><a href="fig-3.html#fig-3k-lefse-of-pathway-abundance-using-shotgun-data"><i class="fa fa-check"></i><b>3.9</b> Fig 3K lefse of pathway abundance using shotgun data</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="methods.html"><a href="methods.html"><i class="fa fa-check"></i><b>4</b> Methods</a></li>
<li class="chapter" data-level="5" data-path="applications.html"><a href="applications.html"><i class="fa fa-check"></i><b>5</b> Applications</a>
<ul>
<li class="chapter" data-level="5.1" data-path="applications.html"><a href="applications.html#example-one"><i class="fa fa-check"></i><b>5.1</b> Example one</a></li>
<li class="chapter" data-level="5.2" data-path="applications.html"><a href="applications.html#example-two"><i class="fa fa-check"></i><b>5.2</b> Example two</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>6</b> Final Words</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">CART microbiome analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="fig-3" class="section level1" number="3">
<h1><span class="header-section-number">Chapter 3</span> Fig 3</h1>
<div id="b-stacked-bar-chart." class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> 3B: stacked bar chart.</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="fig-3.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-2"><a href="fig-3.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vdbR)</span>
<span id="cb4-3"><a href="fig-3.html#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb4-4"><a href="fig-3.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">connect_database</span>(<span class="st">&#39;~/dbConfig.txt&#39;</span>)</span>
<span id="cb4-5"><a href="fig-3.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&quot;asv_annotation_blast_color_ag&quot;</span>);</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="fig-3.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># my table of the CART stool cohort</span></span>
<span id="cb5-2"><a href="fig-3.html#cb5-2" aria-hidden="true" tabindex="-1"></a>stb <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/amplicon/stool/combined_2_meta.csv&#39;</span>)</span>
<span id="cb5-3"><a href="fig-3.html#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get the counts from database and also the color for the asv </span></span>
<span id="cb5-4"><a href="fig-3.html#cb5-4" aria-hidden="true" tabindex="-1"></a>counts_data <span class="ot">&lt;-</span> <span class="fu">get_counts_subset</span>(stb<span class="sc">$</span>sampleid)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="fig-3.html#cb6-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> counts_data <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="fig-3.html#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(asv_key<span class="sc">:</span>count_total, count_relative) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="fig-3.html#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(asv_annotation_blast_color_ag <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="fig-3.html#cb6-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(asv_key,color_label_group_distinct), <span class="at">by =</span> <span class="st">&quot;asv_key&quot;</span>)</span>
<span id="cb6-5"><a href="fig-3.html#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># there are some ASVs that don&#39;t have a color with it, but can use the color for the genus level</span></span>
<span id="cb6-6"><a href="fig-3.html#cb6-6" aria-hidden="true" tabindex="-1"></a>color_group <span class="ot">&lt;-</span> dat <span class="sc">%&gt;%</span> </span>
<span id="cb6-7"><a href="fig-3.html#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(<span class="fu">is.na</span>(.<span class="sc">$</span>color_label_group_distinct))</span>
<span id="cb6-8"><a href="fig-3.html#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># find the genus for these asv</span></span>
<span id="cb6-9"><a href="fig-3.html#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&#39;asv_annotation_blast_ag&#39;</span>)</span>
<span id="cb6-10"><a href="fig-3.html#cb6-10" aria-hidden="true" tabindex="-1"></a>no_color <span class="ot">&lt;-</span> color_group <span class="sc">%&gt;%</span> </span>
<span id="cb6-11"><a href="fig-3.html#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">&#39;TRUE&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-12"><a href="fig-3.html#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(asv_key) <span class="sc">%&gt;%</span> </span>
<span id="cb6-13"><a href="fig-3.html#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(asv_annotation_blast_ag <span class="sc">%&gt;%</span> </span>
<span id="cb6-14"><a href="fig-3.html#cb6-14" aria-hidden="true" tabindex="-1"></a>               <span class="fu">select</span>(asv_key, genus)) </span>
<span id="cb6-15"><a href="fig-3.html#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># find the colors for these genera</span></span>
<span id="cb6-16"><a href="fig-3.html#cb6-16" aria-hidden="true" tabindex="-1"></a>genera_colors <span class="ot">&lt;-</span> no_color <span class="sc">%&gt;%</span> </span>
<span id="cb6-17"><a href="fig-3.html#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(genus) <span class="sc">%&gt;%</span> </span>
<span id="cb6-18"><a href="fig-3.html#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(asv_annotation_blast_color_ag <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="fig-3.html#cb6-19" aria-hidden="true" tabindex="-1"></a>               <span class="fu">distinct</span>(genus, color_label_group_distinct))</span>
<span id="cb6-20"><a href="fig-3.html#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># the full df for the no color genera</span></span>
<span id="cb6-21"><a href="fig-3.html#cb6-21" aria-hidden="true" tabindex="-1"></a>no_color_df <span class="ot">&lt;-</span> no_color <span class="sc">%&gt;%</span> </span>
<span id="cb6-22"><a href="fig-3.html#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(genera_colors)</span>
<span id="cb6-23"><a href="fig-3.html#cb6-23" aria-hidden="true" tabindex="-1"></a>no_color_df_full <span class="ot">&lt;-</span> color_group <span class="sc">%&gt;%</span> </span>
<span id="cb6-24"><a href="fig-3.html#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">&#39;TRUE&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-25"><a href="fig-3.html#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>color_label_group_distinct) <span class="sc">%&gt;%</span> </span>
<span id="cb6-26"><a href="fig-3.html#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(no_color_df <span class="sc">%&gt;%</span> </span>
<span id="cb6-27"><a href="fig-3.html#cb6-27" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(<span class="sc">-</span> genus))</span>
<span id="cb6-28"><a href="fig-3.html#cb6-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-29"><a href="fig-3.html#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># so if the genus is unknown then it&#39;s gonna be assigned &quot;other&quot; gray color  </span></span>
<span id="cb6-30"><a href="fig-3.html#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># the question is do we go one taxa level higher or make a new color base and shades for the new asv</span></span>
<span id="cb6-31"><a href="fig-3.html#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># after discussing with Tsoni, we decided that it&#39;s ok to assign gray to the unknown genus </span></span>
<span id="cb6-32"><a href="fig-3.html#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the new no_color_df_full to the original df</span></span>
<span id="cb6-33"><a href="fig-3.html#cb6-33" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb6-34"><a href="fig-3.html#cb6-34" aria-hidden="true" tabindex="-1"></a>  no_color_df_full,</span>
<span id="cb6-35"><a href="fig-3.html#cb6-35" aria-hidden="true" tabindex="-1"></a>  color_group <span class="sc">%&gt;%</span> </span>
<span id="cb6-36"><a href="fig-3.html#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">&#39;FALSE&#39;</span>)</span>
<span id="cb6-37"><a href="fig-3.html#cb6-37" aria-hidden="true" tabindex="-1"></a>)   </span>
<span id="cb6-38"><a href="fig-3.html#cb6-38" aria-hidden="true" tabindex="-1"></a>dat <span class="sc">%&gt;%</span>  <span class="fu">write_csv</span>(<span class="st">&#39;data/the_data_to_make_panel_B.csv&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="fig-3.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the color palette (inherited from Ying, used in lots of project in our lab, the palette used in the NEJM paper Fig 2D https://www.nejm.org/doi/full/10.1056/NEJMoa1900623)</span></span>
<span id="cb7-2"><a href="fig-3.html#cb7-2" aria-hidden="true" tabindex="-1"></a>asv_color_set <span class="ot">&lt;-</span> asv_annotation_blast_color_ag <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="fig-3.html#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(color,color_label_group_distinct,color_label_group,color_base) <span class="sc">%&gt;%</span> </span>
<span id="cb7-4"><a href="fig-3.html#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(color_label_group_distinct, color) <span class="sc">%&gt;%</span> </span>
<span id="cb7-5"><a href="fig-3.html#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deframe</span>()</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="fig-3.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the beta diversity between the samples which deicide the order of the samples in the plot</span></span>
<span id="cb8-2"><a href="fig-3.html#cb8-2" aria-hidden="true" tabindex="-1"></a>cbd <span class="ot">&lt;-</span> <span class="fu">compute_beta_diversity_and_tsne</span>(<span class="at">sampleid =</span> dat<span class="sc">$</span>sampleid, </span>
<span id="cb8-3"><a href="fig-3.html#cb8-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">taxonomy =</span> dat<span class="sc">$</span>color_label_group_distinct,</span>
<span id="cb8-4"><a href="fig-3.html#cb8-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">count =</span> dat<span class="sc">$</span>count);</span>
<span id="cb8-5"><a href="fig-3.html#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#compute beta diversity</span></span>
<span id="cb8-6"><a href="fig-3.html#cb8-6" aria-hidden="true" tabindex="-1"></a>cbd<span class="sc">$</span><span class="fu">compute_beta_diversity</span>()</span></code></pre></div>
<pre><code>## Time:Composition_matrix:
## Time difference of 0.01121807 secs
## Time:Bray-Curtis matrix:
## Time difference of 0.160646 secs</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="fig-3.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get beta diversity</span></span>
<span id="cb10-2"><a href="fig-3.html#cb10-2" aria-hidden="true" tabindex="-1"></a>d_beta <span class="ot">&lt;-</span> cbd<span class="sc">$</span><span class="fu">get_betadiversity</span>() </span>
<span id="cb10-3"><a href="fig-3.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#compute hierarchical cluster</span></span>
<span id="cb10-4"><a href="fig-3.html#cb10-4" aria-hidden="true" tabindex="-1"></a>hc <span class="ot">&lt;-</span> <span class="fu">hclust</span>(<span class="fu">as.dist</span>(d_beta), <span class="at">method =</span> <span class="st">&#39;complete&#39;</span>)</span>
<span id="cb10-5"><a href="fig-3.html#cb10-5" aria-hidden="true" tabindex="-1"></a>dend <span class="ot">&lt;-</span> <span class="fu">as.dendrogram</span>(hc)</span>
<span id="cb10-6"><a href="fig-3.html#cb10-6" aria-hidden="true" tabindex="-1"></a>sample_dendogram_order <span class="ot">&lt;-</span> <span class="fu">labels</span>(dend)</span>
<span id="cb10-7"><a href="fig-3.html#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="fig-3.html#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="fig-3.html#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  dividing the samples to lower and higher diversity </span></span>
<span id="cb10-10"><a href="fig-3.html#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="fig-3.html#cb10-11" aria-hidden="true" tabindex="-1"></a>div_order <span class="ot">&lt;-</span> stb <span class="sc">%&gt;%</span> </span>
<span id="cb10-12"><a href="fig-3.html#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(simpson_reciprocal) <span class="sc">%&gt;%</span> </span>
<span id="cb10-13"><a href="fig-3.html#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(sampleid)</span>
<span id="cb10-14"><a href="fig-3.html#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb10-15"><a href="fig-3.html#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># how about splitting the above dendrogram order into the low and higher diversity groups</span></span>
<span id="cb10-16"><a href="fig-3.html#cb10-16" aria-hidden="true" tabindex="-1"></a>div_med <span class="ot">&lt;-</span> <span class="fu">median</span>(stb<span class="sc">$</span>simpson_reciprocal)</span>
<span id="cb10-17"><a href="fig-3.html#cb10-17" aria-hidden="true" tabindex="-1"></a>lower_samp <span class="ot">&lt;-</span> stb <span class="sc">%&gt;%</span> </span>
<span id="cb10-18"><a href="fig-3.html#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(simpson_reciprocal <span class="sc">&lt;=</span> div_med) <span class="sc">%&gt;%</span> </span>
<span id="cb10-19"><a href="fig-3.html#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(sampleid)</span>
<span id="cb10-20"><a href="fig-3.html#cb10-20" aria-hidden="true" tabindex="-1"></a>lower_samp_o <span class="ot">&lt;-</span> sample_dendogram_order[sample_dendogram_order <span class="sc">%in%</span> lower_samp]</span>
<span id="cb10-21"><a href="fig-3.html#cb10-21" aria-hidden="true" tabindex="-1"></a>higher_samp_o <span class="ot">&lt;-</span> sample_dendogram_order[<span class="sc">!</span>sample_dendogram_order <span class="sc">%in%</span> lower_samp]</span>
<span id="cb10-22"><a href="fig-3.html#cb10-22" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>sampleid <span class="ot">=</span> <span class="fu">factor</span>(dat<span class="sc">$</span>sampleid,<span class="at">levels =</span> <span class="fu">c</span>(lower_samp_o, higher_samp_o))</span>
<span id="cb10-23"><a href="fig-3.html#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat,<span class="fu">aes</span>(sampleid, count_relative, <span class="at">fill =</span> color_label_group_distinct) ) <span class="sc">+</span></span>
<span id="cb10-24"><a href="fig-3.html#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">position=</span><span class="st">&quot;fill&quot;</span>, <span class="at">width =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-25"><a href="fig-3.html#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb10-26"><a href="fig-3.html#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;&#39;</span>,</span>
<span id="cb10-27"><a href="fig-3.html#cb10-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylab =</span> <span class="st">&#39;Relative counts&#39;</span>) <span class="sc">+</span></span>
<span id="cb10-28"><a href="fig-3.html#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>),</span>
<span id="cb10-29"><a href="fig-3.html#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb10-30"><a href="fig-3.html#cb10-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb10-31"><a href="fig-3.html#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> asv_color_set) <span class="sc">+</span></span>
<span id="cb10-32"><a href="fig-3.html#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/stacked_bar_sorted_with_hclust_lower_and_higher_diversity.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">5</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
<div id="c-alpha-and-beta-diversity-between-cart-patients-and-healthy-volunteers" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> 3C: alpha and beta diversity between CART patients and healthy volunteers</h2>
<div id="alpha-diversity-simpsons-reciprocal" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> alpha diversity (Simpsonâ€™s reciprocal)</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="fig-3.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vdbR)</span>
<span id="cb11-2"><a href="fig-3.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">connect_database</span>(<span class="st">&#39;~/dbConfig.txt&#39;</span>)</span>
<span id="cb11-3"><a href="fig-3.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&quot;healthy_volunteers_ag&quot;</span>)</span>
<span id="cb11-4"><a href="fig-3.html#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&quot;asv_alpha_diversity_ag&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;table asv_alpha_diversity_ag is loaded and filtered for duplicates. Only the replicate of highest coverage is retained.&quot;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="fig-3.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a total of 75 samples </span></span>
<span id="cb13-2"><a href="fig-3.html#cb13-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb13-3"><a href="fig-3.html#cb13-3" aria-hidden="true" tabindex="-1"></a>  stb <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampleid, simpson_reciprocal) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;baseline_CART&#39;</span>),</span>
<span id="cb13-4"><a href="fig-3.html#cb13-4" aria-hidden="true" tabindex="-1"></a>  asv_alpha_diversity_ag <span class="sc">%&gt;%</span> </span>
<span id="cb13-5"><a href="fig-3.html#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sampleid, simpson_reciprocal) <span class="sc">%&gt;%</span> </span>
<span id="cb13-6"><a href="fig-3.html#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(healthy_volunteers_ag <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampleid), <span class="at">by =</span> <span class="st">&quot;sampleid&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-7"><a href="fig-3.html#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;healthy&#39;</span>)</span>
<span id="cb13-8"><a href="fig-3.html#cb13-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-9"><a href="fig-3.html#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sampleid, <span class="at">.keep_all =</span> T)</span>
<span id="cb13-10"><a href="fig-3.html#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="fig-3.html#cb13-11" aria-hidden="true" tabindex="-1"></a>alpha <span class="sc">%&gt;%</span> </span>
<span id="cb13-12"><a href="fig-3.html#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggboxplot</span>(<span class="at">x =</span> <span class="st">&#39;grp&#39;</span>, <span class="at">y =</span> <span class="st">&#39;simpson_reciprocal&#39;</span>, <span class="at">add =</span> <span class="st">&#39;jitter&#39;</span>,</span>
<span id="cb13-13"><a href="fig-3.html#cb13-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">&#39;&#39;</span>, <span class="at">ylab =</span> <span class="st">&#39;Fecal diversity (Simpson Reciprocal)&#39;</span>, <span class="at">xlab =</span> <span class="st">&#39;&#39;</span>, </span>
<span id="cb13-14"><a href="fig-3.html#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&#39;#ED0000&#39;</span>,<span class="st">&#39;#00468B&#39;</span>)) <span class="sc">+</span></span>
<span id="cb13-15"><a href="fig-3.html#cb13-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">stat_compare_means</span>(<span class="at">comparisons=</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;healthy&#39;</span>, <span class="st">&#39;baseline_CART&#39;</span>)),</span>
<span id="cb13-16"><a href="fig-3.html#cb13-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">label=</span> <span class="st">&quot;p.format&quot;</span>,</span>
<span id="cb13-17"><a href="fig-3.html#cb13-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">method=</span> <span class="st">&#39;wilcox.test&#39;</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="beta-diversity-pcoa-of-bray-curtis" class="section level3" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> beta diversity (PCOA of Bray-Curtis)</h3>
<p>PCOA of Bray-Curtis distance with counts matrix at ASV level using an abundannce threshold of 0.01% and a prevalence threshold of 25% between healthy and CART cohort.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="fig-3.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vdbR)</span>
<span id="cb14-2"><a href="fig-3.html#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">connect_database</span>(<span class="st">&#39;~/dbConfig.txt&#39;</span>)</span>
<span id="cb14-3"><a href="fig-3.html#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="fig-3.html#cb14-4" aria-hidden="true" tabindex="-1"></a>healthy <span class="ot">&lt;-</span> healthy_volunteers_ag <span class="sc">%&gt;%</span> </span>
<span id="cb14-5"><a href="fig-3.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(asv_alpha_diversity_ag, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;sampleid&quot;</span>, <span class="st">&quot;oligos_id&quot;</span>)) </span>
<span id="cb14-6"><a href="fig-3.html#cb14-6" aria-hidden="true" tabindex="-1"></a>cts <span class="ot">&lt;-</span> <span class="fu">get_counts_subset</span>(<span class="fu">c</span>(stb<span class="sc">$</span>sampleid, healthy <span class="sc">%&gt;%</span> <span class="fu">pull</span>(sampleid)))</span>
<span id="cb14-7"><a href="fig-3.html#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="fig-3.html#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># a total of 75 samples counts. there are 3 healthy samples I don&#39;t have count .</span></span>
<span id="cb14-9"><a href="fig-3.html#cb14-9" aria-hidden="true" tabindex="-1"></a>nsamp <span class="ot">&lt;-</span> cts <span class="sc">%&gt;%</span> </span>
<span id="cb14-10"><a href="fig-3.html#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sampleid) <span class="sc">%&gt;%</span> </span>
<span id="cb14-11"><a href="fig-3.html#cb14-11" aria-hidden="true" tabindex="-1"></a>  nrow</span>
<span id="cb14-12"><a href="fig-3.html#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="fig-3.html#cb14-13" aria-hidden="true" tabindex="-1"></a>all_pheno <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(healthy <span class="sc">%&gt;%</span> </span>
<span id="cb14-14"><a href="fig-3.html#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sampleid) <span class="sc">%&gt;%</span> </span>
<span id="cb14-15"><a href="fig-3.html#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;healthy&#39;</span>, <span class="at">center =</span> <span class="st">&#39;healthy&#39;</span>),</span>
<span id="cb14-16"><a href="fig-3.html#cb14-16" aria-hidden="true" tabindex="-1"></a>  stb <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampleid, center)  <span class="sc">%&gt;%</span> </span>
<span id="cb14-17"><a href="fig-3.html#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;CART&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-18"><a href="fig-3.html#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sampleid, grp, center)</span>
<span id="cb14-19"><a href="fig-3.html#cb14-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-20"><a href="fig-3.html#cb14-20" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb14-21"><a href="fig-3.html#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sampleid, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb14-22"><a href="fig-3.html#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(asv_alpha_diversity_ag <span class="sc">%&gt;%</span> </span>
<span id="cb14-23"><a href="fig-3.html#cb14-23" aria-hidden="true" tabindex="-1"></a>               <span class="fu">distinct</span>(sampleid, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb14-24"><a href="fig-3.html#cb14-24" aria-hidden="true" tabindex="-1"></a>               <span class="fu">distinct</span>(path_pool, sampleid))</span>
<span id="cb14-25"><a href="fig-3.html#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="fig-3.html#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="fig-3.html#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># filter &gt;0.01% in more than 25% samples</span></span>
<span id="cb14-28"><a href="fig-3.html#cb14-28" aria-hidden="true" tabindex="-1"></a>keepa <span class="ot">&lt;-</span> cts <span class="sc">%&gt;%</span> </span>
<span id="cb14-29"><a href="fig-3.html#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(count_relative <span class="sc">&gt;</span> <span class="fl">0.0001</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-30"><a href="fig-3.html#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(asv_key) <span class="sc">%&gt;%</span> </span>
<span id="cb14-31"><a href="fig-3.html#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="fu">floor</span>(nsamp <span class="sc">*</span> <span class="fl">0.25</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-32"><a href="fig-3.html#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(asv_key)</span>
<span id="cb14-33"><a href="fig-3.html#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="fig-3.html#cb14-34" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="ot">&lt;-</span> cts <span class="sc">%&gt;%</span> </span>
<span id="cb14-35"><a href="fig-3.html#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(asv_key <span class="sc">%in%</span> keepa) <span class="sc">%&gt;%</span> </span>
<span id="cb14-36"><a href="fig-3.html#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sampleid, asv_key,count_relative ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-37"><a href="fig-3.html#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="at">key =</span> <span class="st">&#39;asv_key&#39;</span>, <span class="at">value =</span> <span class="st">&#39;count_relative&#39;</span>, <span class="at">fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-38"><a href="fig-3.html#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="st">&#39;sampleid&#39;</span>)</span>
<span id="cb14-39"><a href="fig-3.html#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="fig-3.html#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan)</span>
<span id="cb14-41"><a href="fig-3.html#cb14-41" aria-hidden="true" tabindex="-1"></a>dist_ <span class="ot">&lt;-</span> <span class="fu">vegdist</span>(cts_fil, <span class="at">method =</span> <span class="st">&#39;bray&#39;</span>)</span>
<span id="cb14-42"><a href="fig-3.html#cb14-42" aria-hidden="true" tabindex="-1"></a>eigen <span class="ot">&lt;-</span> <span class="fu">pcoa</span>(dist_)<span class="sc">$</span>values<span class="sc">$</span>Eigenvalues</span>
<span id="cb14-43"><a href="fig-3.html#cb14-43" aria-hidden="true" tabindex="-1"></a>percent_var <span class="ot">&lt;-</span> <span class="fu">signif</span>(eigen<span class="sc">/</span><span class="fu">sum</span>(eigen), <span class="dv">3</span>)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb14-44"><a href="fig-3.html#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="fig-3.html#cb14-45" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> <span class="fu">cmdscale</span>(dist_, <span class="at">k =</span> <span class="dv">2</span>)</span>
<span id="cb14-46"><a href="fig-3.html#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="fig-3.html#cb14-47" aria-hidden="true" tabindex="-1"></a>bc <span class="sc">%&gt;%</span></span>
<span id="cb14-48"><a href="fig-3.html#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-49"><a href="fig-3.html#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">&#39;sampleid&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-50"><a href="fig-3.html#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-51"><a href="fig-3.html#cb14-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(all_pheno) <span class="sc">%&gt;%</span> </span>
<span id="cb14-52"><a href="fig-3.html#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-53"><a href="fig-3.html#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggscatter</span>(<span class="at">x =</span> <span class="st">&#39;V1&#39;</span>, <span class="at">y =</span> <span class="st">&#39;V2&#39;</span>, <span class="at">color =</span>  <span class="st">&#39;grp&#39;</span>) <span class="sc">+</span></span>
<span id="cb14-54"><a href="fig-3.html#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;PCOA of healthy and CART patients&#39;</span>) <span class="sc">+</span></span>
<span id="cb14-55"><a href="fig-3.html#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">paste0</span>(<span class="st">&quot;PC 1 [&quot;</span>,percent_var[<span class="dv">1</span>],<span class="st">&quot;%]&quot;</span>)) <span class="sc">+</span></span>
<span id="cb14-56"><a href="fig-3.html#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">paste0</span>(<span class="st">&quot;PC 2 [&quot;</span>,percent_var[<span class="dv">2</span>],<span class="st">&quot;%]&quot;</span>)) <span class="sc">+</span></span>
<span id="cb14-57"><a href="fig-3.html#cb14-57" aria-hidden="true" tabindex="-1"></a>  <span class="co">#theme_void() +</span></span>
<span id="cb14-58"><a href="fig-3.html#cb14-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/PCOA(bray-curtis) of healthy and CART patients.pdf&#39;</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>The PCOA with only CART patients data using the same filtering threshold but colored with the different pools they are sequenced from.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="fig-3.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a pcoa at asv level to show they are from different pools and well mixed </span></span>
<span id="cb15-2"><a href="fig-3.html#cb15-2" aria-hidden="true" tabindex="-1"></a>cts <span class="ot">&lt;-</span> <span class="fu">get_counts_subset</span>(<span class="fu">c</span>(stb<span class="sc">$</span>sampleid))</span>
<span id="cb15-3"><a href="fig-3.html#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="fig-3.html#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># filter &gt;0.01% in more than 25% samples</span></span>
<span id="cb15-5"><a href="fig-3.html#cb15-5" aria-hidden="true" tabindex="-1"></a>keepa <span class="ot">&lt;-</span> cts <span class="sc">%&gt;%</span> </span>
<span id="cb15-6"><a href="fig-3.html#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(count_relative <span class="sc">&gt;</span> <span class="fl">0.0001</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="fig-3.html#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(asv_key) <span class="sc">%&gt;%</span> </span>
<span id="cb15-8"><a href="fig-3.html#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="fu">floor</span>(nsamp <span class="sc">*</span> <span class="fl">0.25</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-9"><a href="fig-3.html#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(asv_key)</span>
<span id="cb15-10"><a href="fig-3.html#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="fig-3.html#cb15-11" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="ot">&lt;-</span> cts <span class="sc">%&gt;%</span> </span>
<span id="cb15-12"><a href="fig-3.html#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(asv_key <span class="sc">%in%</span> keepa) <span class="sc">%&gt;%</span> </span>
<span id="cb15-13"><a href="fig-3.html#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sampleid, asv_key,count_relative ) <span class="sc">%&gt;%</span> </span>
<span id="cb15-14"><a href="fig-3.html#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="at">key =</span> <span class="st">&#39;asv_key&#39;</span>, <span class="at">value =</span> <span class="st">&#39;count_relative&#39;</span>, <span class="at">fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-15"><a href="fig-3.html#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="st">&#39;sampleid&#39;</span>)</span>
<span id="cb15-16"><a href="fig-3.html#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="fig-3.html#cb15-17" aria-hidden="true" tabindex="-1"></a>dist_ <span class="ot">&lt;-</span> <span class="fu">vegdist</span>(cts_fil, <span class="at">method =</span> <span class="st">&#39;bray&#39;</span>)</span>
<span id="cb15-18"><a href="fig-3.html#cb15-18" aria-hidden="true" tabindex="-1"></a>eigen <span class="ot">&lt;-</span> <span class="fu">pcoa</span>(dist_)<span class="sc">$</span>values<span class="sc">$</span>Eigenvalues</span>
<span id="cb15-19"><a href="fig-3.html#cb15-19" aria-hidden="true" tabindex="-1"></a>percent_var <span class="ot">&lt;-</span> <span class="fu">signif</span>(eigen<span class="sc">/</span><span class="fu">sum</span>(eigen), <span class="dv">3</span>)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb15-20"><a href="fig-3.html#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="fig-3.html#cb15-21" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> <span class="fu">cmdscale</span>(dist_, <span class="at">k =</span> <span class="dv">2</span>)</span>
<span id="cb15-22"><a href="fig-3.html#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="fig-3.html#cb15-23" aria-hidden="true" tabindex="-1"></a>mp <span class="ot">&lt;-</span> bc <span class="sc">%&gt;%</span></span>
<span id="cb15-24"><a href="fig-3.html#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-25"><a href="fig-3.html#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">&#39;sampleid&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-26"><a href="fig-3.html#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb15-27"><a href="fig-3.html#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(all_pheno) <span class="sc">%&gt;%</span> </span>
<span id="cb15-28"><a href="fig-3.html#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(sampleid, <span class="at">.keep_all =</span> T)  <span class="sc">%&gt;%</span> </span>
<span id="cb15-29"><a href="fig-3.html#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pool =</span> <span class="fu">str_extract</span>(path_pool, <span class="st">&#39;Sample.+/&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-30"><a href="fig-3.html#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pool =</span> <span class="fu">str_replace</span>(pool, <span class="st">&#39;Sample_&#39;</span>,<span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-31"><a href="fig-3.html#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pool =</span> <span class="fu">if_else</span>(<span class="fu">str_detect</span>(pool, <span class="st">&#39;IGO&#39;</span>), <span class="fu">str_extract</span>(pool, <span class="st">&#39;IGO.+$&#39;</span>), pool)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-32"><a href="fig-3.html#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pool =</span> <span class="fu">str_replace</span>(pool, <span class="st">&#39;_1/|_comple.+$&#39;</span>,<span class="st">&#39;&#39;</span>))</span>
<span id="cb15-33"><a href="fig-3.html#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="fig-3.html#cb15-34" aria-hidden="true" tabindex="-1"></a>mp <span class="sc">%&gt;%</span> </span>
<span id="cb15-35"><a href="fig-3.html#cb15-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggscatter</span>(<span class="at">x =</span> <span class="st">&#39;V1&#39;</span>, <span class="at">y =</span> <span class="st">&#39;V2&#39;</span>, <span class="at">color =</span>  <span class="st">&#39;pool&#39;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb15-36"><a href="fig-3.html#cb15-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;PCOA of CART patients&#39;</span>) <span class="sc">+</span></span>
<span id="cb15-37"><a href="fig-3.html#cb15-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">paste0</span>(<span class="st">&quot;PC 1 [&quot;</span>,percent_var[<span class="dv">1</span>],<span class="st">&quot;%]&quot;</span>)) <span class="sc">+</span></span>
<span id="cb15-38"><a href="fig-3.html#cb15-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">paste0</span>(<span class="st">&quot;PC 2 [&quot;</span>,percent_var[<span class="dv">2</span>],<span class="st">&quot;%]&quot;</span>)) <span class="sc">+</span></span>
<span id="cb15-39"><a href="fig-3.html#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#theme_void() +</span></span>
<span id="cb15-40"><a href="fig-3.html#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/PCOA(bray-curtis) (ASV level)of CART patients_pool.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">9</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
</div>
</div>
<div id="fig-3-ef-lefse-analysis-with-taxa-abundance-at-asv-level" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Fig 3 E&amp;F Lefse analysis with taxa abundance at ASV level</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="fig-3.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb16-2"><a href="fig-3.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="fig-3.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sort out the asv counts table and also do filtering (need to have all taxa levels)</span></span>
<span id="cb17-2"><a href="fig-3.html#cb17-2" aria-hidden="true" tabindex="-1"></a>meta <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/amplicon/stool/combined_2_meta.csv&#39;</span>)</span>
<span id="cb17-3"><a href="fig-3.html#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="fig-3.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vdbR)</span>
<span id="cb17-5"><a href="fig-3.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">connect_database</span>(<span class="st">&#39;~/dbConfig.txt&#39;</span>)</span>
<span id="cb17-6"><a href="fig-3.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&#39;asv_annotation_blast_ag&#39;</span>)</span>
<span id="cb17-7"><a href="fig-3.html#cb17-7" aria-hidden="true" tabindex="-1"></a>cts <span class="ot">&lt;-</span> <span class="fu">get_counts_subset</span>(meta<span class="sc">$</span>sampleid)</span>
<span id="cb17-8"><a href="fig-3.html#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="fig-3.html#cb17-9" aria-hidden="true" tabindex="-1"></a>cts_ <span class="ot">&lt;-</span> cts <span class="sc">%&gt;%</span> </span>
<span id="cb17-10"><a href="fig-3.html#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(asv_key, sampleid, count_relative) <span class="sc">%&gt;%</span> </span>
<span id="cb17-11"><a href="fig-3.html#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="at">key =</span> <span class="st">&#39;sampleid&#39;</span>, <span class="at">value =</span> <span class="st">&#39;count_relative&#39;</span>, <span class="at">fill =</span> <span class="dv">0</span>) </span>
<span id="cb17-12"><a href="fig-3.html#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="fig-3.html#cb17-13" aria-hidden="true" tabindex="-1"></a>annot <span class="ot">&lt;-</span> asv_annotation_blast_ag <span class="sc">%&gt;%</span> </span>
<span id="cb17-14"><a href="fig-3.html#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(asv_key <span class="sc">%in%</span> cts_<span class="sc">$</span>asv_key) <span class="sc">%&gt;%</span> </span>
<span id="cb17-15"><a href="fig-3.html#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ordr =</span>  <span class="fu">if_else</span>(<span class="fu">is.na</span>(ordr), <span class="fu">str_glue</span>(<span class="st">&#39;unknown_of_class_{class}&#39;</span>), ordr),</span>
<span id="cb17-16"><a href="fig-3.html#cb17-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">family =</span>  <span class="fu">if_else</span>(<span class="fu">is.na</span>(family), <span class="fu">str_glue</span>(<span class="st">&#39;unknown_of_order_{ordr}&#39;</span>), family),</span>
<span id="cb17-17"><a href="fig-3.html#cb17-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">genus =</span>  <span class="fu">if_else</span>(<span class="fu">is.na</span>(genus) , <span class="fu">str_glue</span>(<span class="st">&#39;unknown_of_family_{family}&#39;</span>), genus),</span>
<span id="cb17-18"><a href="fig-3.html#cb17-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">species =</span>  <span class="fu">if_else</span>(<span class="fu">is.na</span>(species) , <span class="fu">str_glue</span>(<span class="st">&#39;unknown_of_genus_{genus}&#39;</span>), species)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-19"><a href="fig-3.html#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">taxa_asv =</span> <span class="fu">str_glue</span>(<span class="st">&#39;k__{kingdom}|p__{phylum}|c__{class}|o__{ordr}|f__{family}|g__{genus}|s__{species}|a__{asv_key}&#39;</span>))</span>
<span id="cb17-20"><a href="fig-3.html#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="fig-3.html#cb17-21" aria-hidden="true" tabindex="-1"></a>cts_all <span class="ot">&lt;-</span> cts_ <span class="sc">%&gt;%</span> </span>
<span id="cb17-22"><a href="fig-3.html#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(annot <span class="sc">%&gt;%</span>  <span class="fu">select</span>(asv_key, taxa_asv), <span class="at">by  =</span> <span class="st">&#39;asv_key&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-23"><a href="fig-3.html#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>asv_key)  <span class="sc">%&gt;%</span> </span>
<span id="cb17-24"><a href="fig-3.html#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;relab&#39;</span>, <span class="fu">names</span>(.)[<span class="dv">1</span>]<span class="sc">:</span><span class="fu">names</span>(.)[<span class="fu">ncol</span>(.)<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb17-25"><a href="fig-3.html#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(meta <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampleid, cr_d100, toxicity), <span class="at">by =</span> <span class="st">&#39;sampleid&#39;</span>)</span>
<span id="cb17-26"><a href="fig-3.html#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="fig-3.html#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="fig-3.html#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co"># the asv to keep</span></span>
<span id="cb17-29"><a href="fig-3.html#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co"># keep the asvs that show up in at least 25% of the samples</span></span>
<span id="cb17-30"><a href="fig-3.html#cb17-30" aria-hidden="true" tabindex="-1"></a>keepg <span class="ot">&lt;-</span> cts_all <span class="sc">%&gt;%</span> </span>
<span id="cb17-31"><a href="fig-3.html#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(relab <span class="sc">&gt;</span> <span class="fl">0.0001</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-32"><a href="fig-3.html#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb17-33"><a href="fig-3.html#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(taxa_asv) <span class="sc">%&gt;%</span> </span>
<span id="cb17-34"><a href="fig-3.html#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(meta) <span class="sc">*</span> <span class="fl">0.25</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-35"><a href="fig-3.html#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(taxa_asv)</span>
<span id="cb17-36"><a href="fig-3.html#cb17-36" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb17-37"><a href="fig-3.html#cb17-37" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="ot">&lt;-</span> cts_all <span class="sc">%&gt;%</span> </span>
<span id="cb17-38"><a href="fig-3.html#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(taxa_asv <span class="sc">%in%</span> keepg) <span class="sc">%&gt;%</span> </span>
<span id="cb17-39"><a href="fig-3.html#cb17-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;relab&#39;</span>, <span class="at">fill =</span> <span class="dv">0</span>)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="fig-3.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the pheno label for the samples</span></span>
<span id="cb18-2"><a href="fig-3.html#cb18-2" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> meta <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="fig-3.html#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(center, cr_d100<span class="sc">:</span>crs, icans, sampleid) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="fig-3.html#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;pheno&#39;</span>, <span class="st">&#39;value&#39;</span>, cr_d100<span class="sc">:</span>icans) </span>
<span id="cb18-5"><a href="fig-3.html#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="fig-3.html#cb18-6" aria-hidden="true" tabindex="-1"></a>all_sub_pheno <span class="ot">&lt;-</span> pheno <span class="sc">%&gt;%</span> </span>
<span id="cb18-7"><a href="fig-3.html#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(., <span class="fu">list</span>(.<span class="sc">$</span>pheno)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-8"><a href="fig-3.html#cb18-8" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">imap</span>(<span class="sc">~</span> <span class="fu">filter</span>(<span class="at">.data =</span> ., value <span class="sc">!=</span> <span class="st">&#39;not_assessed&#39;</span>))</span>
<span id="cb18-9"><a href="fig-3.html#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="fig-3.html#cb18-10" aria-hidden="true" tabindex="-1"></a>tpheno <span class="ot">&lt;-</span> all_sub_pheno <span class="sc">%&gt;%</span> </span>
<span id="cb18-11"><a href="fig-3.html#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">imap</span>(<span class="cf">function</span>(.x, .y){</span>
<span id="cb18-12"><a href="fig-3.html#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">.data =</span> .x, value) <span class="sc">%&gt;%</span> </span>
<span id="cb18-13"><a href="fig-3.html#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">write.table</span>(<span class="fu">str_glue</span>(<span class="st">&#39;data/amplicon/lefse/pull_{.y}.txt&#39;</span>), <span class="at">sep =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>, <span class="at">quote =</span> F, <span class="at">row.names =</span> T, <span class="at">col.names =</span> F)</span>
<span id="cb18-14"><a href="fig-3.html#cb18-14" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb18-15"><a href="fig-3.html#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="fig-3.html#cb18-16" aria-hidden="true" tabindex="-1"></a>tcts <span class="ot">&lt;-</span> all_sub_pheno <span class="sc">%&gt;%</span> </span>
<span id="cb18-17"><a href="fig-3.html#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">pull</span>(<span class="at">.data =</span> ., sampleid) ) <span class="sc">%&gt;%</span> </span>
<span id="cb18-18"><a href="fig-3.html#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">imap</span>(<span class="sc">~</span> cts_fil <span class="sc">%&gt;%</span> <span class="fu">select</span>(taxa_asv, <span class="fu">matches</span>(.x)) <span class="sc">%&gt;%</span>  <span class="fu">write_tsv</span>(<span class="fu">str_glue</span>(<span class="st">&#39;data/amplicon/lefse/{.y}_asv_tcts.tsv&#39;</span>))) </span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="fig-3.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> data/amplicon/lefse/pull_toxicity.txt data/amplicon/lefse/toxicity_asv_tcts.tsv <span class="op">&gt;</span> data/amplicon/lefse/pull_toxicity_asv_tcts.tsv</span>
<span id="cb19-2"><a href="fig-3.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> data/amplicon/lefse/pull_cr_d100.txt data/amplicon/lefse/cr_d100_asv_tcts.tsv <span class="op">&gt;</span> data/amplicon/lefse/pull_cr_d100_asv_tcts.tsv </span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="fig-3.html#cb20-1" aria-hidden="true" tabindex="-1"></a>fns <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&#39;data/amplicon/lefse/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;pull.*_asv_tcts.tsv$&#39;</span>)</span>
<span id="cb20-2"><a href="fig-3.html#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="fig-3.html#cb20-3" aria-hidden="true" tabindex="-1"></a>cmds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb20-4"><a href="fig-3.html#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fns =</span> fns</span>
<span id="cb20-5"><a href="fig-3.html#cb20-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-6"><a href="fig-3.html#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">format_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_format_input.py {fns}  {fns}.in -c 1  -u 2 -o 1000000   &#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-7"><a href="fig-3.html#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">run_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_run.py -l  4 {fns}.in  {fns}.res&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="fig-3.html#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">plot_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_plot_res.py {fns}.res {fns}.pdf --format pdf  --feature_font_size 4 --width 10 --dpi 300 --title {fns}&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="fig-3.html#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">clado_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_plot_cladogram.py {fns}.res {fns}_clado.pdf  --label_font_size 4 --dpi 300 --format pdf --title {fns}&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-10"><a href="fig-3.html#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fns) <span class="sc">%&gt;%</span> </span>
<span id="cb20-11"><a href="fig-3.html#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-12"><a href="fig-3.html#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(value) <span class="sc">%&gt;%</span> </span>
<span id="cb20-13"><a href="fig-3.html#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">&#39;data/amplicon/lefse/lefse_run_cmd_taxa.sh&#39;</span>, <span class="at">col_names =</span> F)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="fig-3.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run in terminal:</span></span>
<span id="cb21-2"><a href="fig-3.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># bash /Users/daia1/projects/CART_and_microbiome/data/amplicon/lefse/lefse_run_cmd_taxa.sh</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="fig-3.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the results in ggplot</span></span>
<span id="cb22-2"><a href="fig-3.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the input : lefse res files</span></span>
<span id="cb22-3"><a href="fig-3.html#cb22-3" aria-hidden="true" tabindex="-1"></a>fns <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&#39;data/amplicon/lefse/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;pull.*_asv_tcts.tsv.res$&#39;</span>, <span class="at">full.names =</span> T)</span>
<span id="cb22-4"><a href="fig-3.html#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="fig-3.html#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># join all of the tables feature together</span></span>
<span id="cb22-6"><a href="fig-3.html#cb22-6" aria-hidden="true" tabindex="-1"></a>feature <span class="ot">&lt;-</span> fns <span class="sc">%&gt;%</span> </span>
<span id="cb22-7"><a href="fig-3.html#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(fns) <span class="sc">%&gt;%</span> </span>
<span id="cb22-8"><a href="fig-3.html#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">read_tsv</span>(., <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&#39;feature&#39;</span>,<span class="st">&#39;xx&#39;</span>,<span class="st">&#39;direction&#39;</span>,<span class="st">&#39;score&#39;</span>,<span class="st">&#39;pval&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-9"><a href="fig-3.html#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(score))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-10"><a href="fig-3.html#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;group&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-11"><a href="fig-3.html#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_replace</span>(group, <span class="st">&#39;data/amplicon/lefse//pull_&#39;</span>,<span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-12"><a href="fig-3.html#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_replace</span>(group, <span class="st">&#39;_asv_tcts.tsv.res$&#39;</span>,<span class="st">&#39;&#39;</span>)) </span>
<span id="cb22-13"><a href="fig-3.html#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="fig-3.html#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># change the &quot;N&quot; direction to be minus score</span></span>
<span id="cb22-15"><a href="fig-3.html#cb22-15" aria-hidden="true" tabindex="-1"></a>feature <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb22-16"><a href="fig-3.html#cb22-16" aria-hidden="true" tabindex="-1"></a>  feature <span class="sc">%&gt;%</span> </span>
<span id="cb22-17"><a href="fig-3.html#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">split</span>(.<span class="sc">$</span>direction) <span class="sc">%&gt;%</span> </span>
<span id="cb22-18"><a href="fig-3.html#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">&#39;no&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-19"><a href="fig-3.html#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">score =</span> <span class="sc">-</span>score),</span>
<span id="cb22-20"><a href="fig-3.html#cb22-20" aria-hidden="true" tabindex="-1"></a>  feature <span class="sc">%&gt;%</span> </span>
<span id="cb22-21"><a href="fig-3.html#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">split</span>(.<span class="sc">$</span>direction) <span class="sc">%&gt;%</span> </span>
<span id="cb22-22"><a href="fig-3.html#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">&#39;yes&#39;</span>)  </span>
<span id="cb22-23"><a href="fig-3.html#cb22-23" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-24"><a href="fig-3.html#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(group, feature, score) <span class="sc">%&gt;%</span> </span>
<span id="cb22-25"><a href="fig-3.html#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature =</span> <span class="fu">str_replace_all</span>(feature, <span class="st">&#39;^.+</span><span class="sc">\\</span><span class="st">.&#39;</span>, <span class="st">&#39;&#39;</span>))</span>
<span id="cb22-26"><a href="fig-3.html#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="fig-3.html#cb22-27" aria-hidden="true" tabindex="-1"></a>all_title_fs <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb22-28"><a href="fig-3.html#cb22-28" aria-hidden="true" tabindex="-1"></a>axis_text_fs <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb22-29"><a href="fig-3.html#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="fig-3.html#cb22-30" aria-hidden="true" tabindex="-1"></a>CR <span class="ot">&lt;-</span> feature <span class="sc">%&gt;%</span> </span>
<span id="cb22-31"><a href="fig-3.html#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&#39;cr_d100&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-32"><a href="fig-3.html#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, score), <span class="at">y =</span> score, <span class="at">fill =</span> direction)) <span class="sc">+</span></span>
<span id="cb22-33"><a href="fig-3.html#cb22-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_bar</span>( <span class="at">stat =</span> <span class="st">&#39;identity&#39;</span>) <span class="sc">+</span></span>
<span id="cb22-34"><a href="fig-3.html#cb22-34" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb22-35"><a href="fig-3.html#cb22-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#925E9F&#39;</span>, <span class="st">&#39;#42B540&#39;</span>))  <span class="sc">+</span></span>
<span id="cb22-36"><a href="fig-3.html#cb22-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#925E9F&#39;</span>, <span class="st">&#39;#42B540&#39;</span>)) <span class="sc">+</span></span>
<span id="cb22-37"><a href="fig-3.html#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb22-38"><a href="fig-3.html#cb22-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">axis.title.y  =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb22-39"><a href="fig-3.html#cb22-39" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span>all_title_fs),</span>
<span id="cb22-40"><a href="fig-3.html#cb22-40" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb22-41"><a href="fig-3.html#cb22-41" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb22-42"><a href="fig-3.html#cb22-42" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position=</span><span class="st">&#39;bottom&#39;</span>) <span class="sc">+</span></span>
<span id="cb22-43"><a href="fig-3.html#cb22-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_glue</span>(<span class="st">&#39;Response to CR&#39;</span>) ,</span>
<span id="cb22-44"><a href="fig-3.html#cb22-44" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> <span class="st">&#39;Score&#39;</span>)</span>
<span id="cb22-45"><a href="fig-3.html#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="fig-3.html#cb22-46" aria-hidden="true" tabindex="-1"></a>tox <span class="ot">&lt;-</span> feature <span class="sc">%&gt;%</span> </span>
<span id="cb22-47"><a href="fig-3.html#cb22-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&#39;toxicity&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-48"><a href="fig-3.html#cb22-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, score), <span class="at">y =</span> score, <span class="at">fill =</span> direction)) <span class="sc">+</span></span>
<span id="cb22-49"><a href="fig-3.html#cb22-49" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&#39;identity&#39;</span>) <span class="sc">+</span></span>
<span id="cb22-50"><a href="fig-3.html#cb22-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb22-51"><a href="fig-3.html#cb22-51" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#0099B4&#39;</span>, <span class="st">&#39;#AD002A&#39;</span>))  <span class="sc">+</span></span>
<span id="cb22-52"><a href="fig-3.html#cb22-52" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#0099B4&#39;</span>, <span class="st">&#39;#AD002A&#39;</span>)) <span class="sc">+</span></span>
<span id="cb22-53"><a href="fig-3.html#cb22-53" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb22-54"><a href="fig-3.html#cb22-54" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">axis.title.y  =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb22-55"><a href="fig-3.html#cb22-55" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb22-56"><a href="fig-3.html#cb22-56" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span>all_title_fs),</span>
<span id="cb22-57"><a href="fig-3.html#cb22-57" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb22-58"><a href="fig-3.html#cb22-58" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb22-59"><a href="fig-3.html#cb22-59" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_glue</span>(<span class="st">&#39;Response to Toxicity&#39;</span>) ,</span>
<span id="cb22-60"><a href="fig-3.html#cb22-60" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> <span class="st">&#39;Score&#39;</span>)</span>
<span id="cb22-61"><a href="fig-3.html#cb22-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-62"><a href="fig-3.html#cb22-62" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(CR,tox,  </span>
<span id="cb22-63"><a href="fig-3.html#cb22-63" aria-hidden="true" tabindex="-1"></a>          <span class="at">nrow =</span> <span class="dv">2</span>, </span>
<span id="cb22-64"><a href="fig-3.html#cb22-64" aria-hidden="true" tabindex="-1"></a>          <span class="at">align =</span> <span class="st">&#39;hv&#39;</span>,</span>
<span id="cb22-65"><a href="fig-3.html#cb22-65" aria-hidden="true" tabindex="-1"></a>          <span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="fl">1.8</span>,<span class="fl">1.2</span>),</span>
<span id="cb22-66"><a href="fig-3.html#cb22-66" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis =</span> <span class="st">&#39;b&#39;</span>)  <span class="sc">+</span></span>
<span id="cb22-67"><a href="fig-3.html#cb22-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/16s_lefse_combined.pdf&#39;</span>, <span class="at">device =</span> <span class="st">&#39;pdf&#39;</span>, <span class="at">height =</span> <span class="dv">15</span>, <span class="at">width =</span> <span class="dv">15</span>)</span>
<span id="cb22-68"><a href="fig-3.html#cb22-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-69"><a href="fig-3.html#cb22-69" aria-hidden="true" tabindex="-1"></a>g</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>It is important to check the relative abundance of the significant taxa visually.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="fig-3.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to see the relative abundance of those taxa </span></span>
<span id="cb23-2"><a href="fig-3.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to get the top and bottom three taxa of the lefse results</span></span>
<span id="cb23-3"><a href="fig-3.html#cb23-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&#39;data/amplicon/lefse/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;asv_tcts.tsv.res$&#39;</span>, <span class="at">full.names =</span> T)</span>
<span id="cb23-4"><a href="fig-3.html#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="fig-3.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># gather the species level taxa in the lefse significant results</span></span>
<span id="cb23-6"><a href="fig-3.html#cb23-6" aria-hidden="true" tabindex="-1"></a>res_all <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> </span>
<span id="cb23-7"><a href="fig-3.html#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(res) <span class="sc">%&gt;%</span> </span>
<span id="cb23-8"><a href="fig-3.html#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">read_tsv</span>(., <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&#39;feature&#39;</span>,<span class="st">&#39;xx&#39;</span>,<span class="st">&#39;direction&#39;</span>,<span class="st">&#39;score&#39;</span>,<span class="st">&#39;pval&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="fig-3.html#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(score))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="fig-3.html#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">keep</span>(<span class="sc">~</span> <span class="fu">nrow</span>(.) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-11"><a href="fig-3.html#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;res&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-12"><a href="fig-3.html#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">res =</span> <span class="fu">str_replace</span>(res, <span class="st">&#39;^.+//&#39;</span>,<span class="st">&#39;&#39;</span>),</span>
<span id="cb23-13"><a href="fig-3.html#cb23-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">res =</span> <span class="fu">str_replace</span>(res, <span class="st">&#39;_asv.+$&#39;</span>,<span class="st">&#39;&#39;</span>))  <span class="sc">%&gt;%</span> </span>
<span id="cb23-14"><a href="fig-3.html#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">grp =</span> res) <span class="sc">%&gt;%</span> </span>
<span id="cb23-15"><a href="fig-3.html#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(grp <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;pull_cr_d100&#39;</span>,<span class="st">&#39;pull_toxicity&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-16"><a href="fig-3.html#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature =</span> <span class="fu">str_replace_all</span>(feature, <span class="st">&#39;</span><span class="sc">\\</span><span class="st">.&#39;</span>,<span class="st">&#39;</span><span class="sc">\\</span><span class="st">|&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-17"><a href="fig-3.html#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#split(., list(.$grp, .$direction)) %&gt;% </span></span>
<span id="cb23-18"><a href="fig-3.html#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#map_dfr(~ top_n(x = ., n = 4, wt = score) %&gt;% arrange(-score)) %&gt;% </span></span>
<span id="cb23-19"><a href="fig-3.html#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(str_detect(feature, &#39;s__.+$&#39;)) %&gt;% </span></span>
<span id="cb23-20"><a href="fig-3.html#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(!str_detect(feature, &#39;a__.+$&#39;)) %&gt;% </span></span>
<span id="cb23-21"><a href="fig-3.html#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(feature, <span class="st">&#39;g__.+$&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-22"><a href="fig-3.html#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(feature, <span class="st">&#39;s__.+$&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-23"><a href="fig-3.html#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature =</span> <span class="fu">str_replace</span>(feature, <span class="st">&#39;^.+g__&#39;</span>,<span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-24"><a href="fig-3.html#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature =</span> <span class="fu">str_replace</span>(feature, <span class="st">&#39;_Clostridium_&#39;</span>, <span class="st">&#39;[Clostridium]&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-25"><a href="fig-3.html#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb23-26"><a href="fig-3.html#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="fig-3.html#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="fig-3.html#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the relab of those taxa (at species level) in boxplot</span></span>
<span id="cb23-29"><a href="fig-3.html#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="co"># get the species counts of the sampels</span></span>
<span id="cb23-30"><a href="fig-3.html#cb23-30" aria-hidden="true" tabindex="-1"></a>cts_spp <span class="ot">&lt;-</span> cts_ <span class="sc">%&gt;%</span> </span>
<span id="cb23-31"><a href="fig-3.html#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(annot <span class="sc">%&gt;%</span>  <span class="fu">select</span>(asv_key, species), <span class="at">by  =</span> <span class="st">&#39;asv_key&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-32"><a href="fig-3.html#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>asv_key)  <span class="sc">%&gt;%</span> </span>
<span id="cb23-33"><a href="fig-3.html#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;relab&#39;</span>, <span class="fu">names</span>(.)[<span class="dv">1</span>]<span class="sc">:</span><span class="fu">names</span>(.)[<span class="fu">ncol</span>(.)<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb23-34"><a href="fig-3.html#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sampleid, species) <span class="sc">%&gt;%</span> </span>
<span id="cb23-35"><a href="fig-3.html#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Relab =</span> <span class="fu">sum</span>(relab)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-36"><a href="fig-3.html#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sampleid, species, Relab) <span class="sc">%&gt;%</span> </span>
<span id="cb23-37"><a href="fig-3.html#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(meta <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampleid, cr_d100, toxicity), <span class="at">by =</span> <span class="st">&#39;sampleid&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-38"><a href="fig-3.html#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb23-39"><a href="fig-3.html#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="fig-3.html#cb23-40" aria-hidden="true" tabindex="-1"></a>cts_genus <span class="ot">&lt;-</span> cts_ <span class="sc">%&gt;%</span> </span>
<span id="cb23-41"><a href="fig-3.html#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(annot <span class="sc">%&gt;%</span>  <span class="fu">select</span>(asv_key, genus), <span class="at">by  =</span> <span class="st">&#39;asv_key&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-42"><a href="fig-3.html#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>asv_key)  <span class="sc">%&gt;%</span> </span>
<span id="cb23-43"><a href="fig-3.html#cb23-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;relab&#39;</span>, <span class="fu">names</span>(.)[<span class="dv">1</span>]<span class="sc">:</span><span class="fu">names</span>(.)[<span class="fu">ncol</span>(.)<span class="sc">-</span><span class="dv">1</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb23-44"><a href="fig-3.html#cb23-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(sampleid, genus) <span class="sc">%&gt;%</span> </span>
<span id="cb23-45"><a href="fig-3.html#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">Relab =</span> <span class="fu">sum</span>(relab)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-46"><a href="fig-3.html#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sampleid, genus, Relab) <span class="sc">%&gt;%</span> </span>
<span id="cb23-47"><a href="fig-3.html#cb23-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(meta <span class="sc">%&gt;%</span> <span class="fu">select</span>(sampleid, cr_d100, toxicity), <span class="at">by =</span> <span class="st">&#39;sampleid&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-48"><a href="fig-3.html#cb23-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb23-49"><a href="fig-3.html#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="fig-3.html#cb23-50" aria-hidden="true" tabindex="-1"></a>joined <span class="ot">&lt;-</span> cts_genus <span class="sc">%&gt;%</span> </span>
<span id="cb23-51"><a href="fig-3.html#cb23-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(res_all, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;genus&#39;</span> <span class="ot">=</span> <span class="st">&#39;feature&#39;</span>))</span>
<span id="cb23-52"><a href="fig-3.html#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="fig-3.html#cb23-53" aria-hidden="true" tabindex="-1"></a><span class="co"># finally I can do the plotting</span></span>
<span id="cb23-54"><a href="fig-3.html#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="fig-3.html#cb23-55" aria-hidden="true" tabindex="-1"></a>joined  <span class="sc">%&gt;%</span></span>
<span id="cb23-56"><a href="fig-3.html#cb23-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(grp <span class="sc">==</span> <span class="st">&#39;pull_cr_d100&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-57"><a href="fig-3.html#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggboxplot</span>(<span class="at">x =</span> <span class="st">&#39;cr_d100&#39;</span>, <span class="at">y =</span> <span class="st">&#39;Relab&#39;</span>, <span class="at">add =</span> <span class="st">&#39;jitter&#39;</span>, <span class="at">title =</span> <span class="st">&#39;Outcome: cr_d100&#39;</span>) <span class="sc">+</span></span>
<span id="cb23-58"><a href="fig-3.html#cb23-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(direction <span class="sc">~</span> genus, <span class="at">scales=</span><span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb23-59"><a href="fig-3.html#cb23-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/lefse_taxa_crd100.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">13</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>As can be observed in the boxplot, patients that had a CR have higher median relative abundance in Ruminococcus.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="fig-3.html#cb24-1" aria-hidden="true" tabindex="-1"></a>joined  <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="fig-3.html#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(grp <span class="sc">==</span> <span class="st">&#39;pull_toxicity&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="fig-3.html#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggboxplot</span>(<span class="at">x =</span> <span class="st">&#39;toxicity&#39;</span>, <span class="at">y =</span> <span class="st">&#39;Relab&#39;</span>, <span class="at">add =</span> <span class="st">&#39;jitter&#39;</span>, <span class="at">title =</span> <span class="st">&#39;Outcome: toxicity&#39;</span>) <span class="sc">+</span></span>
<span id="cb24-4"><a href="fig-3.html#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(direction <span class="sc">~</span> genus, <span class="at">scales=</span><span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb24-5"><a href="fig-3.html#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/lefse_taxa_toxicity.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">13</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-21-1.png" width="672" />
As can be observed in the boxplot, patients that had a toxicity response have clearly higher median relative abundance in Bacteroides.</p>
</div>
<div id="fig-3d-bayesian-modeling-with-microbiome-alpha-diversity-as-predictor" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Fig 3D Bayesian modeling with microbiome alpha diversity as predictor</h2>
<p>The formular is: CR/Toxicity ~ alpha diversity + center</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="fig-3.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb25-2"><a href="fig-3.html#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="fig-3.html#cb25-3" aria-hidden="true" tabindex="-1"></a>meta <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/amplicon/stool/combined_2_meta.csv&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-4"><a href="fig-3.html#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">logdiv_s =</span> <span class="fu">scale</span>(<span class="fu">log</span>(simpson_reciprocal))) <span class="sc">%&gt;%</span>  </span>
<span id="cb25-5"><a href="fig-3.html#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tox =</span> <span class="fu">if_else</span>(toxicity <span class="sc">==</span> <span class="st">&#39;yes&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb25-6"><a href="fig-3.html#cb25-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">cr100 =</span> <span class="fu">if_else</span>(cr_d100 <span class="sc">==</span> <span class="st">&#39;yes&#39;</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb25-7"><a href="fig-3.html#cb25-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">loca =</span> <span class="fu">if_else</span>(center <span class="sc">==</span> <span class="st">&#39;M&#39;</span>, <span class="dv">1</span>, <span class="dv">2</span>)) <span class="sc">%&gt;%</span>  <span class="co"># MSK 1 ; Upenn 2</span></span>
<span id="cb25-8"><a href="fig-3.html#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">center =</span> <span class="fu">factor</span>(center),</span>
<span id="cb25-9"><a href="fig-3.html#cb25-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">toxicity =</span> <span class="fu">factor</span>(toxicity, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;no&#39;</span>,<span class="st">&#39;yes&#39;</span>)),</span>
<span id="cb25-10"><a href="fig-3.html#cb25-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">cr_d100 =</span> <span class="fu">factor</span>(cr_d100, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&#39;no&#39;</span>,<span class="st">&#39;yes&#39;</span>)))</span>
<span id="cb25-11"><a href="fig-3.html#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="fig-3.html#cb25-12" aria-hidden="true" tabindex="-1"></a>meta <span class="sc">%&gt;%</span> <span class="fu">write_csv</span>(<span class="st">&#39;data/amplicon/stool/combined_2_meta_expanded.csv&#39;</span>)</span>
<span id="cb25-13"><a href="fig-3.html#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="fig-3.html#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb25-15"><a href="fig-3.html#cb25-15" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-16"><a href="fig-3.html#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">tox =</span> meta<span class="sc">$</span>tox,</span>
<span id="cb25-17"><a href="fig-3.html#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs3 =</span> meta<span class="sc">$</span>crs3,</span>
<span id="cb25-18"><a href="fig-3.html#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">cr100 =</span> meta<span class="sc">$</span>cr100,</span>
<span id="cb25-19"><a href="fig-3.html#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> meta<span class="sc">$</span>loca,</span>
<span id="cb25-20"><a href="fig-3.html#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">logdiv_s =</span> meta<span class="sc">$</span>logdiv_s</span>
<span id="cb25-21"><a href="fig-3.html#cb25-21" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<pre><code>## Warning: Unknown or uninitialised column: `crs3`.</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="fig-3.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># outcome: toxicity</span></span>
<span id="cb27-2"><a href="fig-3.html#cb27-2" aria-hidden="true" tabindex="-1"></a>mtox <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb27-3"><a href="fig-3.html#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alist</span>(</span>
<span id="cb27-4"><a href="fig-3.html#cb27-4" aria-hidden="true" tabindex="-1"></a>        tox <span class="sc">~</span> <span class="fu">dbinom</span>( <span class="dv">1</span> , p ) ,</span>
<span id="cb27-5"><a href="fig-3.html#cb27-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> b<span class="sc">*</span>logdiv_s <span class="sc">+</span> a[location] ,</span>
<span id="cb27-6"><a href="fig-3.html#cb27-6" aria-hidden="true" tabindex="-1"></a>        b <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">2</span>), </span>
<span id="cb27-7"><a href="fig-3.html#cb27-7" aria-hidden="true" tabindex="-1"></a>        a[location] <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="fl">0.5</span> )</span>
<span id="cb27-8"><a href="fig-3.html#cb27-8" aria-hidden="true" tabindex="-1"></a>    ) , <span class="at">data=</span>dat_list , <span class="at">chains=</span><span class="dv">4</span> , <span class="at">log_lik=</span><span class="cn">TRUE</span> , <span class="at">cores =</span> <span class="dv">8</span>)</span>
<span id="cb27-9"><a href="fig-3.html#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="fig-3.html#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># make the forest plot </span></span>
<span id="cb27-11"><a href="fig-3.html#cb27-11" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">precis</span>(mtox,  <span class="at">prob =</span> <span class="fl">0.95</span>)  <span class="sc">%&gt;%</span> <span class="fu">as.tibble</span>()</span></code></pre></div>
<pre><code>## Warning: `as.tibble()` was deprecated in tibble 2.0.0.
## Please use `as_tibble()` instead.
## The signature and semantics have changed, see `?as_tibble`.</code></pre>
<pre><code>## Warning in class(x) &lt;- c(setdiff(subclass, tibble_class), tibble_class): Setting
## class(x) to multiple strings (&quot;tbl_df&quot;, &quot;tbl&quot;, ...); result will no longer be an
## S4 object</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="fig-3.html#cb30-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="fig-3.html#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="st">&#39;simpson_reciprocal&#39;</span>)</span>
<span id="cb30-3"><a href="fig-3.html#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">#remove row number 1 (The intercept)</span></span>
<span id="cb30-4"><a href="fig-3.html#cb30-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb30-5"><a href="fig-3.html#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(variable, mean), <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb30-6"><a href="fig-3.html#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">15</span>,</span>
<span id="cb30-7"><a href="fig-3.html#cb30-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">size  =</span> <span class="dv">4</span>, <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb30-8"><a href="fig-3.html#cb30-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-9"><a href="fig-3.html#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin  =</span> <span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>,</span>
<span id="cb30-10"><a href="fig-3.html#cb30-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax  =</span> <span class="st">`</span><span class="at">97.5%</span><span class="st">`</span>),</span>
<span id="cb30-11"><a href="fig-3.html#cb30-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb30-12"><a href="fig-3.html#cb30-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">size  =</span> <span class="fl">0.7</span>,</span>
<span id="cb30-13"><a href="fig-3.html#cb30-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;turquoise4&quot;</span>) <span class="sc">+</span></span>
<span id="cb30-14"><a href="fig-3.html#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) <span class="sc">+</span></span>
<span id="cb30-15"><a href="fig-3.html#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#xlab(&quot;Variables&quot;) + ylab(&quot;Coefficient with 95% CI&quot;) +</span></span>
<span id="cb30-16"><a href="fig-3.html#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.7</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb30-17"><a href="fig-3.html#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-18"><a href="fig-3.html#cb30-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb30-19"><a href="fig-3.html#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb30-20"><a href="fig-3.html#cb30-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;95% confidence interval of the coefficients</span><span class="sc">\n</span><span class="st">for standardized log transformed alpha diversity when outcome is toxicity&#39;</span>,</span>
<span id="cb30-21"><a href="fig-3.html#cb30-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&#39;&#39;</span>,</span>
<span id="cb30-22"><a href="fig-3.html#cb30-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&#39;Association with Toxicity&#39;</span>) <span class="sc">+</span></span>
<span id="cb30-23"><a href="fig-3.html#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/bayesian_div_tox.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: width</code></pre>
<pre><code>## Warning: Width not defined. Set with `position_dodge(width = ?)`

## Warning: Width not defined. Set with `position_dodge(width = ?)`</code></pre>
<p><img src="analysis_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="fig-3.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># outcome : CR_d100</span></span>
<span id="cb33-2"><a href="fig-3.html#cb33-2" aria-hidden="true" tabindex="-1"></a>mcr <span class="ot">&lt;-</span> <span class="fu">ulam</span>( </span>
<span id="cb33-3"><a href="fig-3.html#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alist</span>( </span>
<span id="cb33-4"><a href="fig-3.html#cb33-4" aria-hidden="true" tabindex="-1"></a>        cr100 <span class="sc">~</span> <span class="fu">dbinom</span>( <span class="dv">1</span> , p ) ,</span>
<span id="cb33-5"><a href="fig-3.html#cb33-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> b<span class="sc">*</span>logdiv_s <span class="sc">+</span> a[location] ,</span>
<span id="cb33-6"><a href="fig-3.html#cb33-6" aria-hidden="true" tabindex="-1"></a>        b <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">2</span>),  </span>
<span id="cb33-7"><a href="fig-3.html#cb33-7" aria-hidden="true" tabindex="-1"></a>        a[location] <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="fl">0.5</span> )</span>
<span id="cb33-8"><a href="fig-3.html#cb33-8" aria-hidden="true" tabindex="-1"></a>    ) , <span class="at">data=</span>dat_list , <span class="at">chains=</span><span class="dv">4</span> , <span class="at">log_lik=</span><span class="cn">TRUE</span> , <span class="at">cores =</span> <span class="dv">8</span>)</span>
<span id="cb33-9"><a href="fig-3.html#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="fig-3.html#cb33-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">precis</span>(mcr,  <span class="at">prob =</span> <span class="fl">0.95</span>)  <span class="sc">%&gt;%</span> <span class="fu">as.tibble</span>()</span></code></pre></div>
<pre><code>## Warning in class(x) &lt;- c(setdiff(subclass, tibble_class), tibble_class): Setting
## class(x) to multiple strings (&quot;tbl_df&quot;, &quot;tbl&quot;, ...); result will no longer be an
## S4 object</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="fig-3.html#cb35-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="fig-3.html#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="st">&#39;simpson_reciprocal&#39;</span>)</span>
<span id="cb35-3"><a href="fig-3.html#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">#remove row number 1 (The intercept)</span></span>
<span id="cb35-4"><a href="fig-3.html#cb35-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb35-5"><a href="fig-3.html#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(variable, mean), <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb35-6"><a href="fig-3.html#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">15</span>,</span>
<span id="cb35-7"><a href="fig-3.html#cb35-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">size  =</span> <span class="dv">4</span>, <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb35-8"><a href="fig-3.html#cb35-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb35-9"><a href="fig-3.html#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin  =</span> <span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>,</span>
<span id="cb35-10"><a href="fig-3.html#cb35-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax  =</span> <span class="st">`</span><span class="at">97.5%</span><span class="st">`</span>),</span>
<span id="cb35-11"><a href="fig-3.html#cb35-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb35-12"><a href="fig-3.html#cb35-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">size  =</span> <span class="fl">0.7</span>,</span>
<span id="cb35-13"><a href="fig-3.html#cb35-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;turquoise4&quot;</span>) <span class="sc">+</span></span>
<span id="cb35-14"><a href="fig-3.html#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) <span class="sc">+</span></span>
<span id="cb35-15"><a href="fig-3.html#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Variables&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Coefficient with 95% CI&quot;</span>) <span class="sc">+</span></span>
<span id="cb35-16"><a href="fig-3.html#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.7</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb35-17"><a href="fig-3.html#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb35-18"><a href="fig-3.html#cb35-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb35-19"><a href="fig-3.html#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb35-20"><a href="fig-3.html#cb35-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;95% confidence interval of the coefficients</span><span class="sc">\n</span><span class="st">for standardized log transformed alpha diversity when outcome is CR&#39;</span>) <span class="sc">+</span></span>
<span id="cb35-21"><a href="fig-3.html#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/bayesian_div_cr.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: width</code></pre>
<pre><code>## Warning: Width not defined. Set with `position_dodge(width = ?)`

## Warning: Width not defined. Set with `position_dodge(width = ?)`</code></pre>
<p><img src="analysis_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
</div>
<div id="fig-3g-bayesian-modeling-with-5-genera-abundance-as-predictoroutcome-cr" class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> Fig 3G Bayesian modeling with 5 genera abundance as predictor(outcome CR)</h2>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="fig-3.html#cb38-1" aria-hidden="true" tabindex="-1"></a>genera <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/amplicon/stool/combined_5_genera.csv&#39;</span>)</span>
<span id="cb38-2"><a href="fig-3.html#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># do not standardize the log transformed relative abundance </span></span>
<span id="cb38-3"><a href="fig-3.html#cb38-3" aria-hidden="true" tabindex="-1"></a>meta <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/amplicon/stool/combined_2_meta_expanded.csv&#39;</span>)  <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="fig-3.html#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(genera)</span>
<span id="cb38-5"><a href="fig-3.html#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="fig-3.html#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="fig-3.html#cb38-7" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb38-8"><a href="fig-3.html#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">tox =</span> meta<span class="sc">$</span>tox,</span>
<span id="cb38-9"><a href="fig-3.html#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">cr100 =</span> meta<span class="sc">$</span>cr100,</span>
<span id="cb38-10"><a href="fig-3.html#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> meta<span class="sc">$</span>loca,</span>
<span id="cb38-11"><a href="fig-3.html#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Akkermansia =</span> meta<span class="sc">$</span>Akkermansia,</span>
<span id="cb38-12"><a href="fig-3.html#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Bacteroides =</span> meta<span class="sc">$</span>Bacteroides,</span>
<span id="cb38-13"><a href="fig-3.html#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Enterococcus =</span> meta<span class="sc">$</span>Enterococcus,</span>
<span id="cb38-14"><a href="fig-3.html#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">Faecalibacterium =</span> meta<span class="sc">$</span>Faecalibacterium,</span>
<span id="cb38-15"><a href="fig-3.html#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ruminococcus =</span> meta<span class="sc">$</span>Ruminococcus</span>
<span id="cb38-16"><a href="fig-3.html#cb38-16" aria-hidden="true" tabindex="-1"></a>    ) </span></code></pre></div>
<p>CR ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="fig-3.html#cb39-1" aria-hidden="true" tabindex="-1"></a>gcr <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb39-2"><a href="fig-3.html#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alist</span>(</span>
<span id="cb39-3"><a href="fig-3.html#cb39-3" aria-hidden="true" tabindex="-1"></a>        cr100 <span class="sc">~</span> <span class="fu">dbinom</span>( <span class="dv">1</span> , p ) ,</span>
<span id="cb39-4"><a href="fig-3.html#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> ba<span class="sc">*</span>Akkermansia <span class="sc">+</span> bb<span class="sc">*</span>Bacteroides <span class="sc">+</span> be<span class="sc">*</span>Enterococcus <span class="sc">+</span> bf<span class="sc">*</span>Faecalibacterium <span class="sc">+</span> br<span class="sc">*</span>Ruminococcus <span class="sc">+</span> a[location] ,</span>
<span id="cb39-5"><a href="fig-3.html#cb39-5" aria-hidden="true" tabindex="-1"></a>        ba <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb39-6"><a href="fig-3.html#cb39-6" aria-hidden="true" tabindex="-1"></a>        bb <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb39-7"><a href="fig-3.html#cb39-7" aria-hidden="true" tabindex="-1"></a>        be <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb39-8"><a href="fig-3.html#cb39-8" aria-hidden="true" tabindex="-1"></a>        bf <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb39-9"><a href="fig-3.html#cb39-9" aria-hidden="true" tabindex="-1"></a>        br <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb39-10"><a href="fig-3.html#cb39-10" aria-hidden="true" tabindex="-1"></a>        a[location] <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="fl">0.5</span> )</span>
<span id="cb39-11"><a href="fig-3.html#cb39-11" aria-hidden="true" tabindex="-1"></a>    ) , <span class="at">data=</span>dat_list , <span class="at">chains=</span><span class="dv">4</span> , <span class="at">log_lik=</span><span class="cn">TRUE</span> , <span class="at">cores =</span> <span class="dv">16</span>)</span>
<span id="cb39-12"><a href="fig-3.html#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="fig-3.html#cb39-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">precis</span>(gcr,  <span class="at">prob =</span> <span class="fl">0.95</span>)  <span class="sc">%&gt;%</span> <span class="fu">as.tibble</span>()</span></code></pre></div>
<pre><code>## Warning in class(x) &lt;- c(setdiff(subclass, tibble_class), tibble_class): Setting
## class(x) to multiple strings (&quot;tbl_df&quot;, &quot;tbl&quot;, ...); result will no longer be an
## S4 object</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="fig-3.html#cb41-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="fig-3.html#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="fu">c</span>(<span class="st">&#39;Akkermansia&#39;</span>, <span class="st">&#39;Bacteroides&#39;</span>,<span class="st">&#39;Enterococcus&#39;</span>,<span class="st">&#39;Faecalibacterium&#39;</span>,<span class="st">&#39;Ruminococcus&#39;</span>))</span>
<span id="cb41-3"><a href="fig-3.html#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#remove row number 1 (The intercept)</span></span>
<span id="cb41-4"><a href="fig-3.html#cb41-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb41-5"><a href="fig-3.html#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> variable, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb41-6"><a href="fig-3.html#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">15</span>,</span>
<span id="cb41-7"><a href="fig-3.html#cb41-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">size  =</span> <span class="dv">4</span>, <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb41-8"><a href="fig-3.html#cb41-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="fig-3.html#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin  =</span> <span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>,</span>
<span id="cb41-10"><a href="fig-3.html#cb41-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax  =</span> <span class="st">`</span><span class="at">97.5%</span><span class="st">`</span>),</span>
<span id="cb41-11"><a href="fig-3.html#cb41-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb41-12"><a href="fig-3.html#cb41-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">size  =</span> <span class="fl">0.7</span>,</span>
<span id="cb41-13"><a href="fig-3.html#cb41-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;turquoise4&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-14"><a href="fig-3.html#cb41-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) <span class="sc">+</span></span>
<span id="cb41-15"><a href="fig-3.html#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Variables&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Coefficient with 95% CI&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-16"><a href="fig-3.html#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>)) <span class="sc">+</span></span>
<span id="cb41-17"><a href="fig-3.html#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb41-18"><a href="fig-3.html#cb41-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb41-19"><a href="fig-3.html#cb41-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb41-20"><a href="fig-3.html#cb41-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;CR&#39;</span>) <span class="sc">+</span></span>
<span id="cb41-21"><a href="fig-3.html#cb41-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/bayesian_genera_cr_log10.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: width</code></pre>
<pre><code>## Warning: Width not defined. Set with `position_dodge(width = ?)`

## Warning: Width not defined. Set with `position_dodge(width = ?)`</code></pre>
<p><img src="analysis_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
</div>
<div id="fig3h-histogram-to-illustrate-the-predicted-probability-of-day100-cr" class="section level2" number="3.6">
<h2><span class="header-section-number">3.6</span> Fig3H Histogram to illustrate the predicted probability of day100 CR</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="fig-3.html#cb44-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(gcr) </span>
<span id="cb44-2"><a href="fig-3.html#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="fig-3.html#cb44-3" aria-hidden="true" tabindex="-1"></a>meta_ <span class="ot">&lt;-</span> meta <span class="sc">%&gt;%</span> </span>
<span id="cb44-4"><a href="fig-3.html#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Akkermansia<span class="sc">:</span>Ruminococcus)</span>
<span id="cb44-5"><a href="fig-3.html#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="fig-3.html#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the post coeffs in df format</span></span>
<span id="cb44-7"><a href="fig-3.html#cb44-7" aria-hidden="true" tabindex="-1"></a>postdf <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(<span class="at">ba =</span> post<span class="sc">$</span>ba, <span class="at">bb =</span> post<span class="sc">$</span>bb, <span class="at">be =</span> post<span class="sc">$</span>be, <span class="at">bf =</span> post<span class="sc">$</span>bf, <span class="at">br =</span> post<span class="sc">$</span>br, <span class="at">am =</span> post<span class="sc">$</span>a[,<span class="dv">1</span>])</span>
<span id="cb44-8"><a href="fig-3.html#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="fig-3.html#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># use the 90% and 10% quantile patient data in terms of ruminococcus relab</span></span>
<span id="cb44-10"><a href="fig-3.html#cb44-10" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb44-11"><a href="fig-3.html#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co"># for the top and bottom quantile range of ruminococcus relab</span></span>
<span id="cb44-12"><a href="fig-3.html#cb44-12" aria-hidden="true" tabindex="-1"></a>ru_top <span class="ot">&lt;-</span> meta_ <span class="sc">%&gt;%</span> </span>
<span id="cb44-13"><a href="fig-3.html#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Ruminococcus <span class="sc">&gt;=</span> <span class="fu">quantile</span>(meta<span class="sc">$</span>Ruminococcus, <span class="fl">0.9</span>))</span>
<span id="cb44-14"><a href="fig-3.html#cb44-14" aria-hidden="true" tabindex="-1"></a>ru_bot <span class="ot">&lt;-</span> meta_ <span class="sc">%&gt;%</span> </span>
<span id="cb44-15"><a href="fig-3.html#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Ruminococcus <span class="sc">&lt;=</span> <span class="fu">quantile</span>(meta<span class="sc">$</span>Ruminococcus, <span class="fl">0.1</span>))</span>
<span id="cb44-16"><a href="fig-3.html#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="fig-3.html#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="fig-3.html#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co"># a function to calculate the predicted probability with the randomly drawn coeff from the posterior distributionn and the log10 transformed relative abundance</span></span>
<span id="cb44-19"><a href="fig-3.html#cb44-19" aria-hidden="true" tabindex="-1"></a>per_pt_sample_post_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(lga_, lgb_, lge_, lgf_ , lgr_){</span>
<span id="cb44-20"><a href="fig-3.html#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the input is the log relab of the 5 genera for that patient</span></span>
<span id="cb44-21"><a href="fig-3.html#cb44-21" aria-hidden="true" tabindex="-1"></a>  post_samp <span class="ot">&lt;-</span> postdf <span class="sc">%&gt;%</span> </span>
<span id="cb44-22"><a href="fig-3.html#cb44-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample_n</span>(<span class="at">size =</span> N, <span class="at">replace =</span> F)</span>
<span id="cb44-23"><a href="fig-3.html#cb44-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-24"><a href="fig-3.html#cb44-24" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">=</span> <span class="fu">pmap</span>(post_samp, <span class="cf">function</span>(ba, bb, be, bf, br, am) {</span>
<span id="cb44-25"><a href="fig-3.html#cb44-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inv_logit</span>( ba <span class="sc">*</span> lga_ <span class="sc">+</span> bb <span class="sc">*</span> lgb_ <span class="sc">+</span> be <span class="sc">*</span> lge_ <span class="sc">+</span>  bf <span class="sc">*</span> lgf_ <span class="sc">+</span> br <span class="sc">*</span> lgr_ <span class="sc">+</span> am ) </span>
<span id="cb44-26"><a href="fig-3.html#cb44-26" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb44-27"><a href="fig-3.html#cb44-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_names</span>(<span class="fu">seq</span>(<span class="dv">1</span>, N)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-28"><a href="fig-3.html#cb44-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb44-29"><a href="fig-3.html#cb44-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gather</span>()</span>
<span id="cb44-30"><a href="fig-3.html#cb44-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb44-31"><a href="fig-3.html#cb44-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-32"><a href="fig-3.html#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="fig-3.html#cb44-33" aria-hidden="true" tabindex="-1"></a><span class="co"># for the top quantile patients </span></span>
<span id="cb44-34"><a href="fig-3.html#cb44-34" aria-hidden="true" tabindex="-1"></a>res_top <span class="ot">&lt;-</span> <span class="fu">pmap</span>(ru_top, <span class="cf">function</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus){</span>
<span id="cb44-35"><a href="fig-3.html#cb44-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">per_pt_sample_post_prob</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus)</span>
<span id="cb44-36"><a href="fig-3.html#cb44-36" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb44-37"><a href="fig-3.html#cb44-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste</span>(<span class="st">&#39;P&#39;</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(ru_top)), <span class="at">sep =</span> <span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-38"><a href="fig-3.html#cb44-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;pt&#39;</span>)</span>
<span id="cb44-39"><a href="fig-3.html#cb44-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-40"><a href="fig-3.html#cb44-40" aria-hidden="true" tabindex="-1"></a><span class="co"># for the bottom quantile patients</span></span>
<span id="cb44-41"><a href="fig-3.html#cb44-41" aria-hidden="true" tabindex="-1"></a>res_bot <span class="ot">&lt;-</span> <span class="fu">pmap</span>(ru_bot, <span class="cf">function</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus){</span>
<span id="cb44-42"><a href="fig-3.html#cb44-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">per_pt_sample_post_prob</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus)</span>
<span id="cb44-43"><a href="fig-3.html#cb44-43" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb44-44"><a href="fig-3.html#cb44-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste</span>(<span class="st">&#39;P&#39;</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(ru_bot)), <span class="at">sep =</span> <span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb44-45"><a href="fig-3.html#cb44-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;pt&#39;</span>)</span>
<span id="cb44-46"><a href="fig-3.html#cb44-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-47"><a href="fig-3.html#cb44-47" aria-hidden="true" tabindex="-1"></a><span class="co"># plot them together in one </span></span>
<span id="cb44-48"><a href="fig-3.html#cb44-48" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb44-49"><a href="fig-3.html#cb44-49" aria-hidden="true" tabindex="-1"></a>  res_top <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;high Ruminococcus&#39;</span>),</span>
<span id="cb44-50"><a href="fig-3.html#cb44-50" aria-hidden="true" tabindex="-1"></a>  res_bot <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;low Ruminococcus&#39;</span>)</span>
<span id="cb44-51"><a href="fig-3.html#cb44-51" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb44-52"><a href="fig-3.html#cb44-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gghistogram</span>(<span class="at">x =</span> <span class="st">&#39;value&#39;</span>,<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">&#39;grp&#39;</span>, <span class="at">palette =</span> <span class="st">&#39;nejm&#39;</span>, <span class="at">color =</span> <span class="st">&#39;white&#39;</span>, <span class="at">add =</span> <span class="st">&#39;mean&#39;</span>,</span>
<span id="cb44-53"><a href="fig-3.html#cb44-53" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlab =</span> <span class="st">&#39;Predicted probability of CR d100&#39;</span>, <span class="at">ylab =</span> <span class="st">&#39;Probability density&#39;</span>)<span class="sc">+</span></span>
<span id="cb44-54"><a href="fig-3.html#cb44-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/predicted_CR_Ruminococcus_top_bottom_10.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">5</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="fig-3.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb45-2"><a href="fig-3.html#cb45-2" aria-hidden="true" tabindex="-1"></a>  res_top <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;high Ruminococcus&#39;</span>),</span>
<span id="cb45-3"><a href="fig-3.html#cb45-3" aria-hidden="true" tabindex="-1"></a>  res_bot <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;low Ruminococcus&#39;</span>)</span>
<span id="cb45-4"><a href="fig-3.html#cb45-4" aria-hidden="true" tabindex="-1"></a>)  <span class="sc">%&gt;%</span> </span>
<span id="cb45-5"><a href="fig-3.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grp) <span class="sc">%&gt;%</span> </span>
<span id="cb45-6"><a href="fig-3.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">ave =</span> <span class="fu">mean</span>(value))</span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   grp                 ave
## * &lt;chr&gt;             &lt;dbl&gt;
## 1 high Ruminococcus 0.679
## 2 low Ruminococcus  0.265</code></pre>
<p>As can be observed from the histogram, when the patients have high Ruminococcus content (relative abundance in the top 10% of the current patient cohort), they are predicted to have on average a probability of 0.67 to have CR at day 100; whereas when they have low Ruminococcus content (relative abundance in the bottom 10% of the current patient cohort), they are predicted to have only on average a probability of 0.27 to have CR at day 100.</p>
</div>
<div id="fig-3i-bayesian-modeling-with-5-genera-abundance-as-predictoroutcome-toxicity" class="section level2" number="3.7">
<h2><span class="header-section-number">3.7</span> Fig 3I Bayesian modeling with 5 genera abundance as predictor(outcome toxicity)</h2>
<p>Toxicity ~ Akkermansia + Bacteroides + Enterococcus + Faecalibacterium + Ruminococcus + center</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="fig-3.html#cb47-1" aria-hidden="true" tabindex="-1"></a>gtox <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb47-2"><a href="fig-3.html#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alist</span>(</span>
<span id="cb47-3"><a href="fig-3.html#cb47-3" aria-hidden="true" tabindex="-1"></a>        tox <span class="sc">~</span> <span class="fu">dbinom</span>( <span class="dv">1</span> , p ) ,</span>
<span id="cb47-4"><a href="fig-3.html#cb47-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p) <span class="ot">&lt;-</span> ba<span class="sc">*</span>Akkermansia <span class="sc">+</span> bb<span class="sc">*</span>Bacteroides <span class="sc">+</span> be<span class="sc">*</span>Enterococcus <span class="sc">+</span> bf<span class="sc">*</span>Faecalibacterium <span class="sc">+</span> br<span class="sc">*</span>Ruminococcus <span class="sc">+</span> a[location] ,</span>
<span id="cb47-5"><a href="fig-3.html#cb47-5" aria-hidden="true" tabindex="-1"></a>        ba <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb47-6"><a href="fig-3.html#cb47-6" aria-hidden="true" tabindex="-1"></a>        bb <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb47-7"><a href="fig-3.html#cb47-7" aria-hidden="true" tabindex="-1"></a>        be <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb47-8"><a href="fig-3.html#cb47-8" aria-hidden="true" tabindex="-1"></a>        bf <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb47-9"><a href="fig-3.html#cb47-9" aria-hidden="true" tabindex="-1"></a>        br <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="dv">1</span>),</span>
<span id="cb47-10"><a href="fig-3.html#cb47-10" aria-hidden="true" tabindex="-1"></a>        a[location] <span class="sc">~</span> <span class="fu">dnorm</span>( <span class="dv">0</span> , <span class="fl">0.5</span> )</span>
<span id="cb47-11"><a href="fig-3.html#cb47-11" aria-hidden="true" tabindex="-1"></a>    ) , <span class="at">data=</span>dat_list , <span class="at">chains=</span><span class="dv">4</span> , <span class="at">log_lik=</span><span class="cn">TRUE</span> , <span class="at">cores =</span> <span class="dv">16</span>)</span>
<span id="cb47-12"><a href="fig-3.html#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="fig-3.html#cb47-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">precis</span>(gtox,  <span class="at">prob =</span> <span class="fl">0.95</span>)  <span class="sc">%&gt;%</span> <span class="fu">as.tibble</span>()</span></code></pre></div>
<pre><code>## Warning in class(x) &lt;- c(setdiff(subclass, tibble_class), tibble_class): Setting
## class(x) to multiple strings (&quot;tbl_df&quot;, &quot;tbl&quot;, ...); result will no longer be an
## S4 object</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="fig-3.html#cb49-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="fig-3.html#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="fu">c</span>(<span class="st">&#39;Akkermansia&#39;</span>, <span class="st">&#39;Bacteroides&#39;</span>,<span class="st">&#39;Enterococcus&#39;</span>,<span class="st">&#39;Faecalibacterium&#39;</span>,<span class="st">&#39;Ruminococcus&#39;</span>))</span>
<span id="cb49-3"><a href="fig-3.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">#remove row number 1 (The intercept)</span></span>
<span id="cb49-4"><a href="fig-3.html#cb49-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb49-5"><a href="fig-3.html#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> variable, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb49-6"><a href="fig-3.html#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">15</span>,</span>
<span id="cb49-7"><a href="fig-3.html#cb49-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">size  =</span> <span class="dv">4</span>, <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb49-8"><a href="fig-3.html#cb49-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-9"><a href="fig-3.html#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin  =</span> <span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>,</span>
<span id="cb49-10"><a href="fig-3.html#cb49-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax  =</span> <span class="st">`</span><span class="at">97.5%</span><span class="st">`</span>),</span>
<span id="cb49-11"><a href="fig-3.html#cb49-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.1</span>,</span>
<span id="cb49-12"><a href="fig-3.html#cb49-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">size  =</span> <span class="fl">0.7</span>,</span>
<span id="cb49-13"><a href="fig-3.html#cb49-13" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="at">color=</span><span class="st">&quot;turquoise4&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-14"><a href="fig-3.html#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)) <span class="sc">+</span></span>
<span id="cb49-15"><a href="fig-3.html#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Variables&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Coefficient with 95% CI&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-16"><a href="fig-3.html#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>)) <span class="sc">+</span></span>
<span id="cb49-17"><a href="fig-3.html#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-18"><a href="fig-3.html#cb49-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb49-19"><a href="fig-3.html#cb49-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>)) <span class="sc">+</span></span>
<span id="cb49-20"><a href="fig-3.html#cb49-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&#39;Toxicity&#39;</span>) <span class="sc">+</span></span>
<span id="cb49-21"><a href="fig-3.html#cb49-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/amplicon/bayesian_genera_tox_log10.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">5</span>, <span class="at">height =</span> <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: width</code></pre>
<pre><code>## Warning: Width not defined. Set with `position_dodge(width = ?)`

## Warning: Width not defined. Set with `position_dodge(width = ?)`</code></pre>
<p><img src="analysis_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
</div>
<div id="fig3j-histogram-to-illustrate-the-predicted-probability-of-toxicity" class="section level2" number="3.8">
<h2><span class="header-section-number">3.8</span> Fig3J Histogram to illustrate the predicted probability of toxicity</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="fig-3.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract posterior samples </span></span>
<span id="cb52-2"><a href="fig-3.html#cb52-2" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(gtox) </span>
<span id="cb52-3"><a href="fig-3.html#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="fig-3.html#cb52-4" aria-hidden="true" tabindex="-1"></a>meta_ <span class="ot">&lt;-</span> meta <span class="sc">%&gt;%</span> </span>
<span id="cb52-5"><a href="fig-3.html#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Akkermansia<span class="sc">:</span>Ruminococcus)</span>
<span id="cb52-6"><a href="fig-3.html#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="fig-3.html#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the post coeffs in df format</span></span>
<span id="cb52-8"><a href="fig-3.html#cb52-8" aria-hidden="true" tabindex="-1"></a>postdf <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(<span class="at">ba =</span> post<span class="sc">$</span>ba, <span class="at">bb =</span> post<span class="sc">$</span>bb, <span class="at">be =</span> post<span class="sc">$</span>be, <span class="at">bf =</span> post<span class="sc">$</span>bf, <span class="at">br =</span> post<span class="sc">$</span>br, <span class="at">am =</span> post<span class="sc">$</span>a[,<span class="dv">1</span>])</span>
<span id="cb52-9"><a href="fig-3.html#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="fig-3.html#cb52-10" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb52-11"><a href="fig-3.html#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co"># for the top and bottom quantile range of Bacteroides relab (top and bottom 10%)</span></span>
<span id="cb52-12"><a href="fig-3.html#cb52-12" aria-hidden="true" tabindex="-1"></a>ba_top <span class="ot">&lt;-</span> meta_ <span class="sc">%&gt;%</span> </span>
<span id="cb52-13"><a href="fig-3.html#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Bacteroides <span class="sc">&gt;=</span> <span class="fu">quantile</span>(meta<span class="sc">$</span>Bacteroides, <span class="fl">0.9</span>))</span>
<span id="cb52-14"><a href="fig-3.html#cb52-14" aria-hidden="true" tabindex="-1"></a>ba_bot <span class="ot">&lt;-</span> meta_ <span class="sc">%&gt;%</span> </span>
<span id="cb52-15"><a href="fig-3.html#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Bacteroides <span class="sc">&lt;=</span> <span class="fu">quantile</span>(meta<span class="sc">$</span>Bacteroides, <span class="fl">0.1</span>))</span>
<span id="cb52-16"><a href="fig-3.html#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="fig-3.html#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># a function to calculate the predicted probability with the randomly drawn coeff from the posterior distributionn and the log10 transformed relative abundance</span></span>
<span id="cb52-18"><a href="fig-3.html#cb52-18" aria-hidden="true" tabindex="-1"></a>per_pt_sample_post_prob <span class="ot">&lt;-</span> <span class="cf">function</span>(lga_, lgb_, lge_, lgf_ , lgr_){</span>
<span id="cb52-19"><a href="fig-3.html#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the input is the log relab of the 5 genera for that patient</span></span>
<span id="cb52-20"><a href="fig-3.html#cb52-20" aria-hidden="true" tabindex="-1"></a>  post_samp <span class="ot">&lt;-</span> postdf <span class="sc">%&gt;%</span> </span>
<span id="cb52-21"><a href="fig-3.html#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample_n</span>(<span class="at">size =</span> N, <span class="at">replace =</span> F)</span>
<span id="cb52-22"><a href="fig-3.html#cb52-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-23"><a href="fig-3.html#cb52-23" aria-hidden="true" tabindex="-1"></a>  ret <span class="ot">=</span> <span class="fu">pmap</span>(post_samp, <span class="cf">function</span>(ba, bb, be, bf, br, am) {</span>
<span id="cb52-24"><a href="fig-3.html#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inv_logit</span>( ba <span class="sc">*</span> lga_ <span class="sc">+</span> bb <span class="sc">*</span> lgb_ <span class="sc">+</span> be <span class="sc">*</span> lge_ <span class="sc">+</span>  bf <span class="sc">*</span> lgf_ <span class="sc">+</span> br <span class="sc">*</span> lgr_ <span class="sc">+</span> am ) </span>
<span id="cb52-25"><a href="fig-3.html#cb52-25" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb52-26"><a href="fig-3.html#cb52-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_names</span>(<span class="fu">seq</span>(<span class="dv">1</span>, N)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-27"><a href="fig-3.html#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-28"><a href="fig-3.html#cb52-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gather</span>()</span>
<span id="cb52-29"><a href="fig-3.html#cb52-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ret)</span>
<span id="cb52-30"><a href="fig-3.html#cb52-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-31"><a href="fig-3.html#cb52-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-32"><a href="fig-3.html#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="co"># for the top quantile patients </span></span>
<span id="cb52-33"><a href="fig-3.html#cb52-33" aria-hidden="true" tabindex="-1"></a>res_top <span class="ot">&lt;-</span> <span class="fu">pmap</span>(ba_top, <span class="cf">function</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus){</span>
<span id="cb52-34"><a href="fig-3.html#cb52-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">per_pt_sample_post_prob</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus)</span>
<span id="cb52-35"><a href="fig-3.html#cb52-35" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb52-36"><a href="fig-3.html#cb52-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste</span>(<span class="st">&#39;P&#39;</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(ba_top)), <span class="at">sep =</span> <span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-37"><a href="fig-3.html#cb52-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;pt&#39;</span>)</span>
<span id="cb52-38"><a href="fig-3.html#cb52-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-39"><a href="fig-3.html#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="co"># for the bottom quantile patients  </span></span>
<span id="cb52-40"><a href="fig-3.html#cb52-40" aria-hidden="true" tabindex="-1"></a>res_bot <span class="ot">&lt;-</span> <span class="fu">pmap</span>(ba_bot, <span class="cf">function</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus){</span>
<span id="cb52-41"><a href="fig-3.html#cb52-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">per_pt_sample_post_prob</span>(Akkermansia, Bacteroides, Enterococcus, Faecalibacterium, Ruminococcus)</span>
<span id="cb52-42"><a href="fig-3.html#cb52-42" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> </span>
<span id="cb52-43"><a href="fig-3.html#cb52-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">paste</span>(<span class="st">&#39;P&#39;</span>, <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(ba_bot)), <span class="at">sep =</span> <span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb52-44"><a href="fig-3.html#cb52-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;pt&#39;</span>) </span>
<span id="cb52-45"><a href="fig-3.html#cb52-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-46"><a href="fig-3.html#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="co"># plot them together in one </span></span>
<span id="cb52-47"><a href="fig-3.html#cb52-47" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb52-48"><a href="fig-3.html#cb52-48" aria-hidden="true" tabindex="-1"></a>  res_top <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;top&#39;</span>),</span>
<span id="cb52-49"><a href="fig-3.html#cb52-49" aria-hidden="true" tabindex="-1"></a>  res_bot <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">grp =</span> <span class="st">&#39;bot&#39;</span>)</span>
<span id="cb52-50"><a href="fig-3.html#cb52-50" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb52-51"><a href="fig-3.html#cb52-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gghistogram</span>(<span class="at">x =</span> <span class="st">&#39;value&#39;</span>,<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">&#39;grp&#39;</span>, <span class="at">palette =</span> <span class="st">&#39;nejm&#39;</span>, <span class="at">color =</span> <span class="st">&#39;white&#39;</span>, <span class="at">add =</span> <span class="st">&#39;mean&#39;</span>,</span>
<span id="cb52-52"><a href="fig-3.html#cb52-52" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlab =</span> <span class="st">&#39;Predicted probability of Toxicity&#39;</span>, <span class="at">ylab =</span> <span class="st">&#39;Probability density&#39;</span>) <span class="sc">+</span></span>
<span id="cb52-53"><a href="fig-3.html#cb52-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">&#39;figs/predicted_tox_bacteroides_top_bottom_10.pdf&#39;</span>, <span class="at">width =</span> <span class="dv">7</span>, <span class="at">height =</span> <span class="dv">5</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-29-1.png" width="672" />
As can be observed from the histogram, when the patients have high Bacteroides content (relative abundance in the top 10% of the current patient cohort), they are predicted to almost always have a toxicity response: the histogram amassed on the right side of 0.5; whereas when the patients have low Bacteroides content (relative abundance in the bottom 10% of the current patient cohort), the patients are predicted to have no inclination towards whether or not to have a toxicity response.</p>
</div>
<div id="fig-3k-lefse-of-pathway-abundance-using-shotgun-data" class="section level2" number="3.9">
<h2><span class="header-section-number">3.9</span> Fig 3K lefse of pathway abundance using shotgun data</h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="fig-3.html#cb53-1" aria-hidden="true" tabindex="-1"></a>simple <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&#39;data/shotgun/final_comprehensive_UPDATED_simple.csv&#39;</span>)</span>
<span id="cb53-2"><a href="fig-3.html#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="fig-3.html#cb53-3" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> simple <span class="sc">%&gt;%</span> </span>
<span id="cb53-4"><a href="fig-3.html#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;pheno&#39;</span>, <span class="st">&#39;value&#39;</span>, cr_d100<span class="sc">:</span>toxicity) </span>
<span id="cb53-5"><a href="fig-3.html#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="fig-3.html#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the pathway counts table</span></span>
<span id="cb53-7"><a href="fig-3.html#cb53-7" aria-hidden="true" tabindex="-1"></a>full <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">&#39;data/shotgun/humann3_pathabundance_cpm_joined_unstratified.tsv&#39;</span>)  <span class="sc">%&gt;%</span> </span>
<span id="cb53-8"><a href="fig-3.html#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(<span class="fu">funs</span>(<span class="fu">str_replace</span>(., <span class="st">&#39;^CART_&#39;</span>,<span class="st">&#39;&#39;</span>)))  <span class="sc">%&gt;%</span> </span>
<span id="cb53-9"><a href="fig-3.html#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_all</span>(<span class="fu">funs</span>(<span class="fu">str_replace</span>(., <span class="st">&#39;_humann3$&#39;</span>,<span class="st">&#39;&#39;</span>)))</span></code></pre></div>
<pre><code>## Warning: `funs()` was deprecated in dplyr 0.8.0.
## Please use a list of either functions or lambdas: 
## 
##   # Simple named list: 
##   list(mean = mean, median = median)
## 
##   # Auto named with `tibble::lst()`: 
##   tibble::lst(mean, median)
## 
##   # Using lambdas
##   list(~ mean(., trim = .2), ~ median(., na.rm = TRUE))</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="fig-3.html#cb55-1" aria-hidden="true" tabindex="-1"></a>all_sub_pheno <span class="ot">&lt;-</span> pheno <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="fig-3.html#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(., <span class="fu">list</span>(.<span class="sc">$</span>pheno)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-3"><a href="fig-3.html#cb55-3" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">imap</span>(<span class="sc">~</span> <span class="fu">filter</span>(<span class="at">.data =</span> ., value <span class="sc">!=</span> <span class="st">&#39;not_assessed&#39;</span>))</span>
<span id="cb55-4"><a href="fig-3.html#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="fig-3.html#cb55-5" aria-hidden="true" tabindex="-1"></a>all_sub_pheno <span class="sc">%&gt;%</span> </span>
<span id="cb55-6"><a href="fig-3.html#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">imap</span>(<span class="cf">function</span>(.x, .y){</span>
<span id="cb55-7"><a href="fig-3.html#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">.data =</span> .x, value) <span class="sc">%&gt;%</span> </span>
<span id="cb55-8"><a href="fig-3.html#cb55-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb55-9"><a href="fig-3.html#cb55-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.table</span>(<span class="fu">str_glue</span>(<span class="st">&#39;data/shotgun/pull_{.y}.txt&#39;</span>), <span class="at">sep =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>, <span class="at">quote =</span> F, <span class="at">row.names =</span> T, <span class="at">col.names =</span> F)</span>
<span id="cb55-10"><a href="fig-3.html#cb55-10" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
<pre><code>## $cr_d100
## NULL
## 
## $toxicity
## NULL</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="fig-3.html#cb57-1" aria-hidden="true" tabindex="-1"></a>all_pcts <span class="ot">&lt;-</span> all_sub_pheno <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="fig-3.html#cb57-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span> <span class="fu">pull</span>(<span class="at">.data =</span> ., fid) ) <span class="sc">%&gt;%</span> </span>
<span id="cb57-3"><a href="fig-3.html#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">imap</span>(<span class="sc">~</span> full <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="st">`</span><span class="at"># Pathway</span><span class="st">`</span>, <span class="fu">matches</span>(.x)) <span class="sc">%&gt;%</span> </span>
<span id="cb57-4"><a href="fig-3.html#cb57-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">write_tsv</span>(<span class="fu">str_glue</span>(<span class="st">&#39;data/shotgun/pull_{.y}_pcts.tsv&#39;</span>)))</span>
<span id="cb57-5"><a href="fig-3.html#cb57-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb57-6"><a href="fig-3.html#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># then move to Snakemake do the normalization and the split</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="fig-3.html#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add a filtering step here </span></span>
<span id="cb58-2"><a href="fig-3.html#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 50 and 25% </span></span>
<span id="cb58-3"><a href="fig-3.html#cb58-3" aria-hidden="true" tabindex="-1"></a>pcts <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">&#39;data/shotgun/pull_cr_d100_pcts_cpm_unstratified.tsv&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb58-4"><a href="fig-3.html#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;cpm&#39;</span>, <span class="fu">names</span>(.)[<span class="dv">2</span>]<span class="sc">:</span><span class="fu">names</span>(.)[<span class="fu">ncol</span>(.)]) <span class="sc">%&gt;%</span> </span>
<span id="cb58-5"><a href="fig-3.html#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">pw =</span> <span class="st">`</span><span class="at"># Pathway</span><span class="st">`</span>)</span>
<span id="cb58-6"><a href="fig-3.html#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="fig-3.html#cb58-7" aria-hidden="true" tabindex="-1"></a>keeppw <span class="ot">&lt;-</span> pcts <span class="sc">%&gt;%</span> </span>
<span id="cb58-8"><a href="fig-3.html#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cpm <span class="sc">&gt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-9"><a href="fig-3.html#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb58-10"><a href="fig-3.html#cb58-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(pw) <span class="sc">%&gt;%</span> </span>
<span id="cb58-11"><a href="fig-3.html#cb58-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(simple) <span class="sc">*</span> <span class="fl">0.25</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb58-12"><a href="fig-3.html#cb58-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pw)</span>
<span id="cb58-13"><a href="fig-3.html#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="fig-3.html#cb58-14" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="ot">&lt;-</span> pcts <span class="sc">%&gt;%</span> </span>
<span id="cb58-15"><a href="fig-3.html#cb58-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pw <span class="sc">%in%</span> keeppw) <span class="sc">%&gt;%</span> </span>
<span id="cb58-16"><a href="fig-3.html#cb58-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;cpm&#39;</span>, <span class="at">fill =</span> <span class="dv">0</span>)</span>
<span id="cb58-17"><a href="fig-3.html#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="fig-3.html#cb58-18" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="sc">%&gt;%</span> </span>
<span id="cb58-19"><a href="fig-3.html#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_tsv</span>(<span class="st">&#39;data/shotgun/pull_cr_d100_pcts_cpm_unstratified_fil.tsv&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="fig-3.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tox</span></span>
<span id="cb59-2"><a href="fig-3.html#cb59-2" aria-hidden="true" tabindex="-1"></a>pcts <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="st">&#39;data/shotgun/pull_toxicity_pcts_cpm_unstratified.tsv&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb59-3"><a href="fig-3.html#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;cpm&#39;</span>, <span class="fu">names</span>(.)[<span class="dv">2</span>]<span class="sc">:</span><span class="fu">names</span>(.)[<span class="fu">ncol</span>(.)]) <span class="sc">%&gt;%</span> </span>
<span id="cb59-4"><a href="fig-3.html#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">pw =</span> <span class="st">`</span><span class="at"># Pathway</span><span class="st">`</span>)</span>
<span id="cb59-5"><a href="fig-3.html#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="fig-3.html#cb59-6" aria-hidden="true" tabindex="-1"></a>keeppw <span class="ot">&lt;-</span> pcts <span class="sc">%&gt;%</span> </span>
<span id="cb59-7"><a href="fig-3.html#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cpm <span class="sc">&gt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span></span>
<span id="cb59-8"><a href="fig-3.html#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb59-9"><a href="fig-3.html#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(pw) <span class="sc">%&gt;%</span> </span>
<span id="cb59-10"><a href="fig-3.html#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="fu">floor</span>(<span class="fu">nrow</span>(simple) <span class="sc">*</span> <span class="fl">0.25</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb59-11"><a href="fig-3.html#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pw)</span>
<span id="cb59-12"><a href="fig-3.html#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="fig-3.html#cb59-13" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="ot">&lt;-</span> pcts <span class="sc">%&gt;%</span> </span>
<span id="cb59-14"><a href="fig-3.html#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pw <span class="sc">%in%</span> keeppw) <span class="sc">%&gt;%</span> </span>
<span id="cb59-15"><a href="fig-3.html#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spread</span>(<span class="st">&#39;sampleid&#39;</span>, <span class="st">&#39;cpm&#39;</span>, <span class="at">fill =</span> <span class="dv">0</span>)</span>
<span id="cb59-16"><a href="fig-3.html#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="fig-3.html#cb59-17" aria-hidden="true" tabindex="-1"></a>cts_fil <span class="sc">%&gt;%</span> </span>
<span id="cb59-18"><a href="fig-3.html#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_tsv</span>(<span class="st">&#39;data/shotgun/pull_toxicity_pcts_cpm_unstratified_fil.tsv&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="fig-3.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PATHWAY</span></span>
<span id="cb60-2"><a href="fig-3.html#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># I already normalized the pcts so don&#39;t need to normalize again here </span></span>
<span id="cb60-3"><a href="fig-3.html#cb60-3" aria-hidden="true" tabindex="-1"></a>fns <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&#39;data/shotgun/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;lefse_ready_pcts.tsv$&#39;</span>)</span>
<span id="cb60-4"><a href="fig-3.html#cb60-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-5"><a href="fig-3.html#cb60-5" aria-hidden="true" tabindex="-1"></a>cmds <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb60-6"><a href="fig-3.html#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">fns =</span> fns</span>
<span id="cb60-7"><a href="fig-3.html#cb60-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb60-8"><a href="fig-3.html#cb60-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">format_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_format_input.py {fns}  {fns}.in -c 1 -u 2&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-9"><a href="fig-3.html#cb60-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">run_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_run.py {fns}.in  {fns}.res&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-10"><a href="fig-3.html#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">plot_cmd =</span> <span class="fu">str_glue</span>(<span class="st">&#39;lefse_plot_res.py {fns}.res {fns}.pdf --format pdf  --feature_font_size 4 --width 10 --dpi 300 --title {fns}&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-11"><a href="fig-3.html#cb60-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fns) <span class="sc">%&gt;%</span> </span>
<span id="cb60-12"><a href="fig-3.html#cb60-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-13"><a href="fig-3.html#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(value) <span class="sc">%&gt;%</span> </span>
<span id="cb60-14"><a href="fig-3.html#cb60-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">&#39;data/shotgun/lefse_run_cmd.sh&#39;</span>, <span class="at">col_names =</span> F)</span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="fig-3.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># look at the pathway results</span></span>
<span id="cb61-2"><a href="fig-3.html#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vdbR)</span>
<span id="cb61-3"><a href="fig-3.html#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">connect_database</span>(<span class="st">&#39;~/dbConfig.txt&#39;</span>)</span>
<span id="cb61-4"><a href="fig-3.html#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&#39;metacyc_pathway_name&#39;</span>)</span>
<span id="cb61-5"><a href="fig-3.html#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">get_table_from_database</span>(<span class="st">&#39;metacyc_pathway_ontology&#39;</span>)</span>
<span id="cb61-6"><a href="fig-3.html#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="fig-3.html#cb61-7" aria-hidden="true" tabindex="-1"></a>fns <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&#39;data/shotgun/&#39;</span>, <span class="at">pattern =</span> <span class="st">&#39;lefse_ready_pcts.tsv.res$&#39;</span>, <span class="at">full.names =</span> T)</span>
<span id="cb61-8"><a href="fig-3.html#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="fig-3.html#cb61-9" aria-hidden="true" tabindex="-1"></a>feature <span class="ot">&lt;-</span> fns <span class="sc">%&gt;%</span> </span>
<span id="cb61-10"><a href="fig-3.html#cb61-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(fns) <span class="sc">%&gt;%</span> </span>
<span id="cb61-11"><a href="fig-3.html#cb61-11" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span> <span class="fu">read_tsv</span>(., <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&#39;pathway&#39;</span>,<span class="st">&#39;xx&#39;</span>,<span class="st">&#39;direction&#39;</span>,<span class="st">&#39;score&#39;</span>,<span class="st">&#39;pval&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-12"><a href="fig-3.html#cb61-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(score))) <span class="sc">%&gt;%</span> </span>
<span id="cb61-13"><a href="fig-3.html#cb61-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="at">.id =</span> <span class="st">&#39;group&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-14"><a href="fig-3.html#cb61-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_replace</span>(group, <span class="st">&#39;data/shotgun//&#39;</span>,<span class="st">&#39;&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-15"><a href="fig-3.html#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">str_replace</span>(group, <span class="st">&#39;_lefse_ready_pcts.tsv.res$&#39;</span>,<span class="st">&#39;&#39;</span>)) </span>
<span id="cb61-16"><a href="fig-3.html#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="fig-3.html#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="co"># change the &quot;N&quot; direction to be minus score</span></span>
<span id="cb61-18"><a href="fig-3.html#cb61-18" aria-hidden="true" tabindex="-1"></a>feature <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb61-19"><a href="fig-3.html#cb61-19" aria-hidden="true" tabindex="-1"></a>  feature <span class="sc">%&gt;%</span> </span>
<span id="cb61-20"><a href="fig-3.html#cb61-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">split</span>(.<span class="sc">$</span>direction) <span class="sc">%&gt;%</span> </span>
<span id="cb61-21"><a href="fig-3.html#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">&#39;no&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-22"><a href="fig-3.html#cb61-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">score =</span> <span class="sc">-</span>score),</span>
<span id="cb61-23"><a href="fig-3.html#cb61-23" aria-hidden="true" tabindex="-1"></a>  feature <span class="sc">%&gt;%</span> </span>
<span id="cb61-24"><a href="fig-3.html#cb61-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">split</span>(.<span class="sc">$</span>direction) <span class="sc">%&gt;%</span> </span>
<span id="cb61-25"><a href="fig-3.html#cb61-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">&#39;yes&#39;</span>)  </span>
<span id="cb61-26"><a href="fig-3.html#cb61-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-27"><a href="fig-3.html#cb61-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(group, pathway, score) <span class="sc">%&gt;%</span> </span>
<span id="cb61-28"><a href="fig-3.html#cb61-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pwid =</span> <span class="fu">str_extract</span>(pathway, <span class="st">&#39;^.+_PWY|^PWY.*_</span><span class="sc">\\</span><span class="st">d{3,4}&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-29"><a href="fig-3.html#cb61-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pwid =</span> <span class="fu">str_replace_all</span>(pwid, <span class="st">&#39;_&#39;</span>, <span class="st">&#39;-&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-30"><a href="fig-3.html#cb61-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pwid =</span> <span class="fu">if_else</span>(<span class="fu">str_detect</span>(pathway, <span class="st">&#39;^TCA&#39;</span>), <span class="st">&#39;TCA&#39;</span>, pwid)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-31"><a href="fig-3.html#cb61-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pwid =</span> <span class="fu">if_else</span>(<span class="fu">str_detect</span>(pathway, <span class="st">&#39;^NAD&#39;</span>), <span class="st">&#39;NAD-BIOSYNTHESIS-II&#39;</span>, pwid)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-32"><a href="fig-3.html#cb61-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(metacyc_pathway_name <span class="sc">%&gt;%</span> <span class="fu">select</span>(pwid, pw_name)) <span class="sc">%&gt;%</span> </span>
<span id="cb61-33"><a href="fig-3.html#cb61-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(metacyc_pathway_ontology <span class="sc">%&gt;%</span> <span class="fu">select</span>(pwid, l4<span class="sc">:</span>l9))</span>
<span id="cb61-34"><a href="fig-3.html#cb61-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb61-35"><a href="fig-3.html#cb61-35" aria-hidden="true" tabindex="-1"></a>all_title_fs <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb61-36"><a href="fig-3.html#cb61-36" aria-hidden="true" tabindex="-1"></a>axis_text_fs <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb61-37"><a href="fig-3.html#cb61-37" aria-hidden="true" tabindex="-1"></a>CR <span class="ot">&lt;-</span> feature <span class="sc">%&gt;%</span> </span>
<span id="cb61-38"><a href="fig-3.html#cb61-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&#39;pull_cr_d100&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-39"><a href="fig-3.html#cb61-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(pathway, score), <span class="at">y =</span> score, <span class="at">fill =</span> direction)) <span class="sc">+</span></span>
<span id="cb61-40"><a href="fig-3.html#cb61-40" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_bar</span>( <span class="at">stat =</span> <span class="st">&#39;identity&#39;</span>) <span class="sc">+</span></span>
<span id="cb61-41"><a href="fig-3.html#cb61-41" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb61-42"><a href="fig-3.html#cb61-42" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#925E9F&#39;</span>, <span class="st">&#39;#42B540&#39;</span>))  <span class="sc">+</span></span>
<span id="cb61-43"><a href="fig-3.html#cb61-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#925E9F&#39;</span>, <span class="st">&#39;#42B540&#39;</span>)) <span class="sc">+</span></span>
<span id="cb61-44"><a href="fig-3.html#cb61-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb61-45"><a href="fig-3.html#cb61-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">axis.title.y  =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb61-46"><a href="fig-3.html#cb61-46" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span>all_title_fs),</span>
<span id="cb61-47"><a href="fig-3.html#cb61-47" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb61-48"><a href="fig-3.html#cb61-48" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb61-49"><a href="fig-3.html#cb61-49" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position=</span><span class="st">&#39;bottom&#39;</span>) <span class="sc">+</span></span>
<span id="cb61-50"><a href="fig-3.html#cb61-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_glue</span>(<span class="st">&#39;Response to CR&#39;</span>) ,</span>
<span id="cb61-51"><a href="fig-3.html#cb61-51" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> <span class="st">&#39;Score&#39;</span>)</span>
<span id="cb61-52"><a href="fig-3.html#cb61-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-53"><a href="fig-3.html#cb61-53" aria-hidden="true" tabindex="-1"></a>tox <span class="ot">&lt;-</span> feature <span class="sc">%&gt;%</span> </span>
<span id="cb61-54"><a href="fig-3.html#cb61-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&#39;pull_toxicity&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb61-55"><a href="fig-3.html#cb61-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(pathway, score), <span class="at">y =</span> score, <span class="at">fill =</span> direction)) <span class="sc">+</span></span>
<span id="cb61-56"><a href="fig-3.html#cb61-56" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">&#39;identity&#39;</span>) <span class="sc">+</span></span>
<span id="cb61-57"><a href="fig-3.html#cb61-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb61-58"><a href="fig-3.html#cb61-58" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#0099B4&#39;</span>, <span class="st">&#39;#AD002A&#39;</span>))  <span class="sc">+</span></span>
<span id="cb61-59"><a href="fig-3.html#cb61-59" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#0099B4&#39;</span>, <span class="st">&#39;#AD002A&#39;</span>)) <span class="sc">+</span></span>
<span id="cb61-60"><a href="fig-3.html#cb61-60" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb61-61"><a href="fig-3.html#cb61-61" aria-hidden="true" tabindex="-1"></a>            <span class="fu">theme</span>(<span class="at">axis.title.y  =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb61-62"><a href="fig-3.html#cb61-62" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb61-63"><a href="fig-3.html#cb61-63" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size=</span>all_title_fs),</span>
<span id="cb61-64"><a href="fig-3.html#cb61-64" aria-hidden="true" tabindex="-1"></a>                  <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span>axis_text_fs),</span>
<span id="cb61-65"><a href="fig-3.html#cb61-65" aria-hidden="true" tabindex="-1"></a>                  <span class="at">legend.position=</span><span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span></span>
<span id="cb61-66"><a href="fig-3.html#cb61-66" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_glue</span>(<span class="st">&#39;Response to Toxicity&#39;</span>) ,</span>
<span id="cb61-67"><a href="fig-3.html#cb61-67" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> <span class="st">&#39;Score&#39;</span>)</span>
<span id="cb61-68"><a href="fig-3.html#cb61-68" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(CR,tox,  </span>
<span id="cb61-69"><a href="fig-3.html#cb61-69" aria-hidden="true" tabindex="-1"></a>          <span class="at">nrow =</span> <span class="dv">2</span>, </span>
<span id="cb61-70"><a href="fig-3.html#cb61-70" aria-hidden="true" tabindex="-1"></a>          <span class="at">rel_heights =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>),</span>
<span id="cb61-71"><a href="fig-3.html#cb61-71" aria-hidden="true" tabindex="-1"></a>          <span class="at">align =</span> <span class="st">&#39;hv&#39;</span>,</span>
<span id="cb61-72"><a href="fig-3.html#cb61-72" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis =</span> <span class="st">&#39;b&#39;</span>)</span></code></pre></div>
<p><img src="analysis_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="methods.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["analysis.pdf", "analysis.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
